---
title: "JSDM models test"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(arm)
library(jagsUI)
library(ggplot2)
library(gridExtra)
library(parallel)
library(Rcpp)
library(magrittr)
library(purrr)
library(readr)
library(corrplot)
library(gjam)
library(Hmsc)
library(rlist)
library(ggmcmc)
library(devtools)
#install_github("sbfnk/fitR")
library(fitR) ###load through github
library(reshape)
library(AUC)
library(ggthemes)
library(mcclust.ext)
Rcpp::sourceCpp('/Users/dariabystrova/Documents/GitHub/gjamed/src/cppFns.cpp')
source("/Users/dariabystrova/Documents/GitHub/gjamed/R/gjamHfunctions_mod.R")


#setwd("C:/Users/giaru/Desktop/Documents/GitHub/Ecology-models/simcoms-master")

setwd("/Users/dariabystrova/Documents/GitHub/Ecology-models/simcoms-master/ExampleFiles")
#setwd("~/Tesi/Code/Ecology-models-master/simcoms-master")
load("params.rds")
load("sim_names.rds")
load("comp_inter.rds")
load("fac_inter.rds")
#sim_data<-readRDS("sim_data.rds")

load_object <- function(file) {
  tmp <- new.env()
  load(file = file, envir = tmp)
  tmp[[ls(tmp)[1]]]
}
```



## Data description

Data was simulated using VirtualCommunity code.\
Simulated data contains 20 data sets. \

In this file we have compared the 3 models HMSC,GJAM, JSDM on 21 simulated Dataset.\

We have studied the correlation and partial correlation matrices for the given datasets, as the coeff  to recover the true interactions used for modelling this datasets, by comparing estimated correlation matrix and matrix representing true interactions.\
There is a  separate file, with the functions needed to fit each model and study the convergence and more parameters are presented.\


## Environment filtering 5 species




### JSDM


```{r draw, echo=FALSE, include=FALSE}
setwd("~/Documents/GitHub/Ecology-models/simcoms-master")
sim_data<-readRDS("sim_data.rds")

#setwd("~/Tesi/Code/Ecology-models-master/simcoms-master/ExampleFiles")
prob_cooccur_es <- function(Y) {
  K <- ncol(Y)
  ans <- matrix(0, K, K)
  
  for (k in 1:K) {
    for (kk in 1:K) {
      N1 <- sum(Y[, k])
      N2 <- sum(Y[, kk])
      N <- nrow(Y)
      j <- max(0, N1 + N2 - N):min(N1, N2)
      p <- vector("numeric", length(j))
      for (i in seq_along(j)) {
        p[i] <- (
          choose(N, j[i]) * choose(N - j[i], N2 - j[i]) *
            choose(N - N2, N1 - j[i])
        ) / (
          choose(N, N2) * choose(N, N1)
        )
      }  
      ans[k, kk] <- (sum(Y[, k] + Y[, kk] == 2) - sum(p * j)) / N
    }
  }
  ans
}

me5 <- load_object("model-2019-04-09-19-02-16.rda")
jsdm_conv<-function(mod) {
  n_eff_beta<- as.data.frame(t(mod$n.eff$B))
  n_eff_beta$parameter<- "beta"
  n_eff_sigma<- as.data.frame(mod$n.eff$Rho)
  n_eff_sigma$parameter<- "correlation"
  neff<- rbind(n_eff_beta,n_eff_sigma)
  neff_mod<- melt(neff, id=c("parameter"), variable_name = "effective size")
  p<- ggplot(neff_mod, aes(x=value, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth=100) + xlab("effective size") +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+
   ggtitle("Effective size for the parameters beta and coefficients of correlation matrix")
  plot(p)
  Rhat_beta<- as.data.frame(t(mod$Rhat$B))
  Rhat_beta$parameter<- "beta"
  Rhat_sigma<- as.data.frame(mod$Rhat$Rho)
  Rhat_sigma$parameter<- "correlation"
  Rhat<- rbind(Rhat_beta,Rhat_sigma)
  Rhat_mod<- melt(Rhat, id=c("parameter"), variable_name = "Rhat")
  Rhat_mod_nonNA<- Rhat_mod[!is.na(Rhat_mod$value),]
  p2<- ggplot(Rhat_mod_nonNA, aes(x=value, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth = 0.01) +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+ xlab("Rhat") +
   ggtitle("Rhat for the parameters beta and the coefficients of correlation matrix")
  plot(p2)
  
}


jsdm_tau<-function(jsdm_mod){
  nsamples<-jsdm_mod$mcmc.info$n.samples
  ns<- ncol(jsdm_mod$model$cluster1$data()$Y)
  postT<-array(dim=c(ns,ns,nsamples))
  for(i in 1:nsamples){
   postT[,,i]<- -stats::cov2cor(solve(jsdm_mod$sims.list$Rho[i,,]+0.1*diag(ns)))
  }
  
  postTMean = apply(postT,c(1,2),mean)
  postTUp=apply(postT,c(1,2),quantile,0.95)
  postTLo=apply(postT,c(1,2),quantile,0.05)
  
  Toplot_T<-postTMean*(!(postTUp>0 & postTLo<0))
  return(list(Tau=postTMean,Tau_sign=Toplot_T)) 
}


jsdm_conv(me5)
me5$mcmc.info[1:7]



metrics_jsdm<-function(model,fac=NULL,comp=NULL,only_env=T){
  
  Rho<-model
  #{
    if(!is.null(comp) & !is.null(fac)){
    fac_comp <- fac-comp
    TP_comp <- FN_comp <-TP_fac <- FN_fac <- FP <- TN <- wrong <- 0
    for(i in 1:(nrow(Rho)-1)){
      for(j in (i+1):ncol(Rho)){
        if(fac_comp[i,j]>0 & Rho[i,j] >0)
          TP_fac=TP_fac+1
        if(fac_comp[i,j]>0 & Rho[i,j] == 0)
          FN_fac=FN_fac+1
        if(fac_comp[i,j]==0 & Rho[i,j] == 0)
           TN=TN+1
        if(fac_comp[i,j]==0 & Rho[i,j] != 0)
           FP=FP+1
        if(fac_comp[i,j]< 0 & Rho[i,j] < 0)
          TP_comp=TP_comp+1
        if(fac_comp[i,j]<0 & Rho[i,j] == 0)
          FN_comp=FN_comp+1
        if((fac_comp[i,j]<0 & Rho[i,j] > 0) | (fac_comp[i,j]>0 & Rho[i,j] < 0))
          wrong=wrong+1
      }
    }
    
  }else{
    if(!is.null(comp)){
    
    TP_comp <- FN_comp <- FP <- TN <- wrong <- 0
    TP_fac <- FN_fac<-NULL
    for(i in 1:(nrow(Rho)-1)){
      for(j in (i+1):ncol(Rho)){
        if(comp[i,j]>0 & Rho[i,j] <0)
          TP_comp=TP_comp+1
        if(comp[i,j]>0 & Rho[i,j] >0)
          wrong=wrong+1
        if(comp[i,j]>0 & Rho[i,j] == 0)
          FN_comp=FN_comp+1
        if(comp[i,j]==0 & Rho[i,j] == 0)
          TN=TN+1
        if(comp[i,j]==0 & Rho[i,j] != 0)
          FP=FP+1
       
      }
#    }
#    }
    }
    }
  if(!is.null(fac)){
    
            TP_fac <- FN_fac <- FP <- TN <- wrong <- 0
            TP_comp <- FN_comp<-NULL
            for(i in 1:(nrow(Rho)-1)){
              for(j in (i+1):ncol(Rho)){
                   if(fac[i,j]>0 & Rho[i,j] >0)
                      TP_fac=TP_fac+1
                   if(fac[i,j]>0 & Rho[i,j] <0)
                      wrong = wrong+1
                   if(fac[i,j]>0 & Rho[i,j] == 0)
                      FN_fac=FN_fac+1
                   if(fac[i,j]==0 & Rho[i,j] == 0)
                      TN=TN+1
                   if(fac[i,j]==0 & Rho[i,j] != 0)
                      FP=FP+1
              }
            }
  }
 }
  if(only_env){
    
      FP <- TN <- 0
      TP_fac <- FN_fac<-TP_comp <- FN_comp<-wrong<-NULL
         for(i in 1:(nrow(Rho)-1)){
            for(j in (i+1):nrow(Rho)){
                if(Rho[i,j] != 0)
                      FP=FP+1
                if(Rho[i,j] == 0)
                      TN=TN+1
              }
            }
      
  }
  success_env<-TN/(TN+FP)
  
  if(!is.null(TP_comp)){success_comp <- TP_comp/(TP_comp+FN_comp)}else{ success_comp = NULL}
  
  if(!is.null(TP_fac)) {success_fac <- TP_fac/(TP_fac+FN_fac)}else{ success_fac = NULL}
  
   list("FP"=FP,"TN"=TN,"TP_comp"=TP_comp,"FN_comp"=FN_comp,"TP_fac"=TP_fac,"FN_fac"=FN_fac,
       "wrong"=wrong,"success_env"=success_env,"success_comp"=success_comp,"success_fac"=success_fac)
}


predict_y_jsdm <- function(x, ns = 1000) {
  data   <- if(x$parallel) x$model[[1]]$data() else x$model$data()
  n      <- data$n
  nsp    <- data$J
  n.samples  <- x$mcmc.info$n.samples
  B <- x$sims.list$B
  X <- data$X
  Y <- data$Y
  inprod_mat <- cppFunction(
    "NumericMatrix inprod_mat(NumericMatrix X, NumericMatrix B) {
    
    int nX = X.nrow();
    int nB = B.nrow();
    int nK = X.ncol();
    
    NumericMatrix theta(nX, nB);
    
    for (int i = 0; i < nX; i++) {
    for (int j = 0; j < nB; j++) {
    theta(i, j) = 0;
    for (int k = 0; k < nK; k++) {
    theta(i, j) += X(i, k) * B(j, k);
    }
    }
    }
    
    return(theta);
    
}"
  )
  vapply(
    floor(seq(1, n.samples, length.out = ns)),
    function(x){ inprod_mat(data$X, B[x, ,])},
    matrix(NA_real_, n, nsp)
  )
}


```


```{r heat, include=FALSE}
data<-sim_data$EnvEvenSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

Y_cor<-cor(data$Y)

to_prec<-function(m){
  n<-dim(m)[1]
  Tau_n<-matrix(nrow=n, ncol=n)
  for (j in 1:n) {
   for (k in 1:n){
    Tau_n[j, k] <-  -m[j, k]/sqrt((m[j,j]*m[k,k]))
   }
  }
  return(Tau_n)
}

#Tau_n<-matrix(nrow=dim(model$mean$Tau)[1], ncol=dim(model$mean$Tau)[1])
#Tau_n<-to_prec(me5$mean$Tau)
#Tau_k<-Tau_n*(!(model$q97.5$Tau>0 & model$q2.5$Tau<0))




par(mfrow=c(2,4),oma = c(3, 1, 2, 1))
cols = colorRampPalette(c("dark blue","white","red"))
col2 <- colorRampPalette(c("#4393C3", "#2166AC", "#053061",
                           "#FDDBC7", "#FFFFFF", "#D1E5F0", "#92C5DE",
                           "#67001F", "#B2182B", "#D6604D", "#F4A582"))

gcols = colorRampPalette(c( "White", "White", "Black"))

corrplot(Y_cor, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation cor(Y)")
corrplot(me5$mean$EnvRho, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("EnvRho")
corrplot(me5$mean$EnvRho*(!me5$overlap0$EnvRho), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("EnvRho signif")
corrplot(me5$mean$Rho, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Rho")
corrplot(me5$mean$Rho*(!me5$overlap0$Rho), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Rho signif")
# corrplot(Tau_n, diag = FALSE, order ="original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
# title("Tau")
# corrplot(Tau_n*(!me5$overlap0$Tau), diag = FALSE, order ="original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
# title("Tau signif")

j_metric_e5<-metrics_jsdm((!me5$overlap0$Rho)*me5$mean$Rho)
j_metric_e5_p<-metrics_jsdm(jsdm_tau(me5)$Tau_sign)




mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =as.matrix(me5$mean$Rho*(!me5$overlap0$Rho))) 
mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(me5)$Tau_sign) 



####Prediction
pred_j<-pnorm(predict_y_jsdm(me5))
pred_j_mean <- apply(pred_j, 1:2, mean)

pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)
pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

#prepare AUC
AUC_j_env<-vector()
for(i in 1:data$J) AUC_j_env<-c(AUC_j_env,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```


### GJAM 

```{r gjam functions,include=FALSE}
############################################################Functions
makeSymm <- function(m) {
  m[upper.tri(m)] <- t(m)[upper.tri(m)]
  return(m)
}

expandSigma_rmd <- function(sigma, S){

  ss <- diag(S)
  ss[lower.tri(ss,diag=T)] <- sigma
  ss[upper.tri(ss)] <- t(ss)[upper.tri(ss)]
  ss
}

convert_to_m<-function(ar){
  d <-floor((sqrt(length(ar)*8+1)-1)/2)
  C <- matrix(0,d,d)
  i.lwr <- which(lower.tri(C, diag = TRUE), arr.ind=TRUE)
  C[i.lwr] <- ar
  C<-makeSymm(C)
  return(t(C))
}



dataprep<- function(datap){
  data <- list(
    Y = subset(datap, select = -env),
    X = cbind(1, scale(poly(datap$env, 2))),
    covx = cov(cbind(1, scale(poly(datap$env, 2)))),
    K = 3,
    J = ncol(datap) - 1,
    n = nrow(datap),
    I = diag(ncol(datap) - 1),
    df = ncol(datap)
  )
  return(data)
}


metrics_gjam<-function(Rho, comp=NULL,fac=NULL,only_env=T){
    if(!is.null(comp) & !is.null(fac)){
    fac_comp <- fac-comp
    TP_comp <- FN_comp <-TP_fac <- FN_fac <- FP <- TN <- wrong <- 0
    for(i in 1:(nrow(Rho)-1)){
      for(j in (i+1):ncol(Rho)){
        if(fac_comp[i,j]>0 & Rho[i,j] >0)
          TP_fac=TP_fac+1
        if(fac_comp[i,j]>0 & Rho[i,j] == 0)
          FN_fac=FN_fac+1
        if(fac_comp[i,j]==0 & Rho[i,j] == 0)
           TN=TN+1
        if(fac_comp[i,j]==0 & Rho[i,j] != 0)
           FP=FP+1
        if(fac_comp[i,j]< 0 & Rho[i,j] < 0)
          TP_comp=TP_comp+1
        if(fac_comp[i,j]<0 & Rho[i,j] == 0)
          FN_comp=FN_comp+1
        if((fac_comp[i,j]<0 & Rho[i,j] > 0) | (fac_comp[i,j]>0 & Rho[i,j] < 0))
          wrong=wrong+1
      }
    }
    
  }else{
    if(!is.null(comp)){
    TP_comp <- FN_comp <- FP <- TN <- wrong <- 0
    TP_fac <- FN_fac<-NULL
    for(i in 1:(nrow(Rho)-1)){
      for(j in (i+1):ncol(Rho)){
        if(comp[i,j]>0 & Rho[i,j] <0)
          TP_comp=TP_comp+1
        if(comp[i,j]>0 & Rho[i,j] >0)
          wrong=wrong+1
        if(comp[i,j]>0 & Rho[i,j] == 0)
          FN_comp=FN_comp+1
        if(comp[i,j]==0 & Rho[i,j] == 0)
          TN=TN+1
        if(comp[i,j]==0 & Rho[i,j] != 0)
          FP=FP+1
       
      }
    }
    }
  if(!is.null(fac)){
    
            TP_fac <- FN_fac <- FP <- TN <- wrong <- 0
            TP_comp <- FN_comp<-NULL
            for(i in 1:(nrow(Rho)-1)){
              for(j in (i+1):ncol(Rho)){
                   if(fac[i,j]>0 & Rho[i,j] >0)
                      TP_fac=TP_fac+1
                   if(fac[i,j]>0 & Rho[i,j] <0)
                      wrong = wrong+1
                   if(fac[i,j]>0 & Rho[i,j] == 0)
                      FN_fac=FN_fac+1
                   if(fac[i,j]==0 & Rho[i,j] == 0)
                      TN=TN+1
                   if(fac[i,j]==0 & Rho[i,j] != 0)
                      FP=FP+1
              }
            }
  }
  }
  if(only_env){
    
      FP <- TN <- 0
      TP_fac <- FN_fac<-TP_comp <- FN_comp<-wrong<-NULL
         for(i in 1:(nrow(Rho)-1)){
            for(j in (i+1):nrow(Rho)){
                if(Rho[i,j] != 0)
                      FP=FP+1
                if(Rho[i,j] == 0)
                      TN=TN+1
              }
            }
      
  }
  success_env<-TN/(TN+FP)
  
  if(!is.null(TP_comp)){success_comp <- TP_comp/(TP_comp+FN_comp)}else{ success_comp = NULL}
  
  if(!is.null(TP_fac)) {success_fac <- TP_fac/(TP_fac+FN_fac)}else{ success_fac = NULL}
  
  list("FP"=FP,"TN"=TN,"TP_comp"=TP_comp,"FN_comp"=FN_comp,"TP_fac"=TP_fac,"FN_fac"=FN_fac,
       "wrong"=wrong,"success_env"=success_env,"success_comp"=success_comp,"success_fac"=success_fac)
  }


fit_gjam<-function(data, it=2500,burn=500 , name="./gjam_models/temp.rda",interact=diag(ncol(data$Y))){
  #setup parameters
  data <- list(
    Y = subset(data, select = -env),
    X = cbind(1, scale(poly(data$env, 2))),
    covx = cov(cbind(1, scale(poly(data$env, 2)))),
    K = 3,
    J = ncol(data) - 1,
    n = nrow(data),
    I = diag(ncol(data) - 1),
    df = ncol(data)
  )
  xdata<-as.data.frame(data$X[,-1])
  colnames(xdata)<- c("env","env2")
  ydata<-as.data.frame(data$Y)
  ###formula
  formula<-as.formula( ~env+ env2)
  ml   <- list(ng = it, burnin = burn, typeNames = 'PA', PREDICTX = F)
  ####fit
  
  mod_gjam1  <- gjam(formula, xdata = xdata, ydata = ydata, modelList = ml)
  mod_gjam2  <- gjam(formula, xdata = xdata, ydata = ydata, modelList = ml)
  gjam_mods<- list(m1=mod_gjam1,m2=mod_gjam2)
  
  save(gjam_mods, file = name)
  gjam_bs<- mcmc.list(mcmc(gjam_mods$m1$chains$bgibbsUn,start=burn, end=it),mcmc(gjam_mods$m2$chains$bgibbsUn,start=burn, end=it))
  gjam_sigma<- mcmc.list(mcmc(gjam_mods$m1$chains$sgibbs,start=burn, end=it),mcmc(gjam_mods$m2$chains$sgibbs,start=burn, end=it))
  
  
  hist(effectiveSize(gjam_bs), main="ess(beta)",lwd=2,col=gray(.6))
  hist(gelman.diag(gjam_bs, multivariate=FALSE)$psrf,lwd=2,col=gray(.6), main="psrf(beta)")
  #gelman.plot(gjam_bs)
  #xyplot(gjam_bs)
  #traceplot(gjam_sigma)
  hist(effectiveSize(gjam_sigma), main="ess(beta)",lwd=2,col=gray(.6))
  hist(gelman.diag(gjam_sigma,multivariate=FALSE)$psrf,lwd=2,col=gray(.6), main="psrf(sigma)")
  #gelman.plot(gjam_sigma)
  #xyplot(gjam_sigma)
  
  gjam_mods_2bgibbs<-  abind(gjam_mods$m1$chains$bgibbsUn,gjam_mods$m2$chains$bgibbsUn, along = 3)
  gjam_mods_2sgibbs<-abind(gjam_mods$m1$chains$sgibbs,gjam_mods$m2$chains$sgibbs, along = 3)
  
  #postH<-apply(mod_gjam1$chains$sgibbs, 2, quantile,0.95)
  #postL<-apply(mod_gjam1$chains$sgibbs, 2, quantile,0.05)
  postH<- apply(gjam_mods_2sgibbs, 2, quantile,0.95)
  postL<-apply(gjam_mods_2sgibbs, 2, quantile,0.05)
  post_mean<-apply(gjam_mods_2sgibbs, 2, mean)
  
  
  pH<-convert_to_m(postH)
  pL<-convert_to_m(postL)
  post_mean_s<-convert_to_m(post_mean)
  #R_sign<-cov2cor(mod_gjam1$parameters$sigMu)*(!(pH>0 & pL<0))
  R_sign<-cov2cor(post_mean_s)*(!(pH>0 & pL<0))
  
  sgibbs<-abind(mod_gjam1$chains$sgibbs[-(1:burn),],mod_gjam2$chains$sgibbs[-(1:burn),],along=1)

  tau<-array(NA,dim=c(data$J,data$J,dim(sgibbs)[1]))
  for(j in 1:dim(sgibbs)[1]){
    ss <- expandSigma_rmd(sgibbs[j,], S = data$J)
    si <- solve(ss)
    tau[,,j] <- -cov2cor(si)
  }

  tau_mean<-apply(tau,c(1,2), mean)
  tau_HI<-apply(tau,c(1,2),quantile,0.95)
  tau_LO<-apply(tau,c(1,2),quantile,0.05)
  
  Tau_sign<-tau_mean*(!(tau_HI>0 & tau_LO<0))
  
  #newdata   <- list(xdata = xdata, nsim = 50 )

  x<- data$X
  #p1<-gjamPredict(mod_gjam1)
  mu<-array(NA,dim=c(data$n,data$J,it))
  for(k in 1:it){
      for(j in 1:data$J){
    
         mu[,j,k] <- pnorm(x%*%mod_gjam1$chains$bgibbs[k,(3*(j-1)+1):(3*j)])
          
    }
  }
  
    return(list(Rho_sign=R_sign,Tau_sign=Tau_sign,predict=mu))
  }


###this function only loads the model and return the R and T significant
load_gjam<-function(data,it=2500,burn=500,name="./gjam_models/temp.rda",interact=diag(ncol(data$Y))){
  #setup parameters
  data <- list(
    Y = subset(data, select = -env),
    X = cbind(1, scale(poly(data$env, 2))),
    covx = cov(cbind(1, scale(poly(data$env, 2)))),
    K = 3,
    J = ncol(data) - 1,
    n = nrow(data),
    I = diag(ncol(data) - 1),
    df = ncol(data)
  )

  xdata<-as.data.frame(data$X[,-1])

  gj_mod<-load_object(name)
  S<-ncol(data$Y)
  gjam_bs<- mcmc.list(mcmc(gj_mod$m1$chains$bgibbsUn[-(1:burn),]),mcmc(gj_mod$m2$chains$bgibbsUn[-(1:burn),]))
  gjam_sigma<- mcmc.list(mcmc(gj_mod$m1$chains$sgibbs[-(1:burn),]),mcmc(gj_mod$m2$chains$sgibbs[-(1:burn),]))
  ###NEW plot for effective size
  n_eff_beta<- as.data.frame(effectiveSize(gjam_bs))
  colnames(n_eff_beta)<- c("value")
  n_eff_beta$parameter<- "beta"
  n_eff_sigma<- as.data.frame(effectiveSize(gjam_sigma))
  colnames(n_eff_sigma)<- c("value")
  n_eff_sigma$parameter<- "correlation"
  neff<- rbind(n_eff_beta,n_eff_sigma)
  p<- ggplot(neff, aes(x=value, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity") + xlab("effective size") +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+
   ggtitle("Effective size for the parameters beta and coefficients of correlation matrix")
  plot(p)
  
  Rhat_beta<-as.data.frame(gelman.diag(gjam_bs, multivariate=FALSE)$psrf)
  Rhat_beta$parameter<- "beta"
  Rhat_sigma<- as.data.frame(gelman.diag(gjam_sigma, multivariate=FALSE)$psrf)
  Rhat_sigma$parameter<- "correlation"
  Rhat<- rbind(Rhat_beta,Rhat_sigma)
  p2<- ggplot(Rhat, aes(x= Rhat$`Point est.`, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth =1) +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+ xlab("Rhat") +
   ggtitle("Rhat for the parameters beta and the coefficients of correlation matrix")
  plot(p2)

  #gelman.plot(gjam_bs)
  #xyplot(gjam_bs)
  #traceplot(gjam_sigma)
  #gelman.plot(gjam_sigma)
  #xyplot(gjam_sigma)
  
  gjam_mods_2bgibbs<-  abind(gj_mod$m1$chains$bgibbsUn,gj_mod$m2$chains$bgibbsUn, along = 3)
  gjam_mods_2sgibbs<-abind(gj_mod$m1$chains$sgibbs,gj_mod$m2$chains$sgibbs, along = 3)
  
  #postH<-apply(mod_gjam1$chains$sgibbs, 2, quantile,0.95)
  #postL<-apply(mod_gjam1$chains$sgibbs, 2, quantile,0.05)
  postH<- apply(gjam_mods_2sgibbs, 2, quantile,0.95)
  postL<-apply(gjam_mods_2sgibbs, 2, quantile,0.05)
  post_mean<-apply(gjam_mods_2sgibbs, 2, mean)
  
  
  pH<-convert_to_m(postH)
  pL<-convert_to_m(postL)
  post_mean_s<-convert_to_m(post_mean)
  S_mean<-cov2cor(post_mean_s)
  #R_sign<-cov2cor(mod_gjam1$parameters$sigMu)*(!(pH>0 & pL<0))
  R_sign<-cov2cor(post_mean_s)*(!(pH>0 & pL<0))
  
  sgibbs<-abind(gj_mod$m1$chains$sgibbs[-(1:burn),],gj_mod$m2$chains$sgibbs[-(1:burn),],along=1)

  tau<-array(NA,dim=c(data$J,data$J,dim(sgibbs)[1]))
  for(j in 1:dim(sgibbs)[1]){
    ss <- expandSigma_rmd(sgibbs[j,], S = data$J)
    si <- solve(ss)
    tau[,,j] <- -cov2cor(si)
  }

  tau_mean<-apply(tau,c(1,2), mean)
  tau_HI<-apply(tau,c(1,2),quantile,0.95)
  tau_LO<-apply(tau,c(1,2),quantile,0.05)
  
  Tau_sign<-tau_mean*(!(tau_HI>0 & tau_LO<0))

  x<- data$X
  #p1<-gjamPredict(mod_gjam1)
  mu<-array(NA,dim=c(data$n,data$J,it))
  for(k in 1:it){
      for(j in 1:data$J){
    
         mu[,j,k] <- pnorm(x%*%gj_mod$m1$chains$bgibbs[k,(3*(j-1)+1):(3*j)])
          
    }
  }

  par(mfrow=c(2,3),oma = c(1, 1, 1, 1))
  corrplot(cor(data$Y), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Correlation cor(Y)")
  corrplot(S_mean, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("R")
  corrplot(gj_mod$m1$parameters$ematrix, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("E matrix")
  corrplot(Tau_sign, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Tau signif")
  corrplot(R_sign, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("R signif")
  corrplot(interact, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("True interactions")
  
  return(list(Rho_sign=R_sign,Tau_sign=Tau_sign,predict=mu))
}

######################################################################
```




```{r gjam env5,include=TRUE,echo=FALSE}
##to setup chains parameters
data<-sim_data$EnvEvenSp5
#mod_gjam<-fit_gjam(data,10000,1000,name="./gjam_models/gjam5env.rda")
mod_gjam<-load_gjam(data,10000,1000,name="./gjam_models/gjam5env.rda")

g_metric_e5<-metrics_gjam(mod_gjam$Rho_sign)
g_metric_e5_p<-metrics_gjam(mod_gjam$Tau_sign)
cat(" ")
cat(sprintf("Success rate: %s\n", metrics_gjam(mod_gjam$Rho_sign)$success_env))

mod_list_Rho<-list.append(mod_list_Rho,gjam=mod_gjam$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,gjam=mod_gjam$Tau_sign)
#####Prediction
pred_gj_mean <-apply(mod_gjam$predict, 1:2,mean)
pred_gj_05 <- apply(mod_gjam$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(mod_gjam$predict, 1:2,quantile,0.95)

AUC_g_env<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_env<-c(AUC_g_env,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

```



### HMSC



```{r hmsc,  include=TRUE, echo=FALSE}
fit_hmsc<-function(data,label="Fit",nsamples = 1000,nchains=2,name="./new_new_HMmodels/hmtemp.rda" ){
  if (label=="Fit"){
    Y_data = subset(data, select = -env)
    ns<- ncol(Y_data)
    np <- nrow(Y_data)
    X<-scale(poly(data$env[1:np], 2))
    colnames(X)<-c("env","env2")
    studyDesign = data.frame(sample = as.factor(1:np))
    rL = HmscRandomLevel(units = studyDesign$sample)
    m = Hmsc(Y=as.matrix(Y_data), XData=as.data.frame(X), XFormula=~env+env2, distr="probit",
             studyDesign = studyDesign, ranLevels = list(sample = rL))
    m = sampleMcmc(m, nsamples, thin=10, adaptNf=c(200,200), transient=500,nChains=nchains ,verbose=F)
    save(m, file = name)
    return(m)
  }
  if (label=="Load"){
    return(load_object(name))
  }
}


data<-sim_data$EnvEvenSp5
hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm5env.rda" )

```



###Convergence:


```{r hmsc convergence, include=TRUE, echo = FALSE}
hm_conv<-function(mod){
  codaList = convertToCodaObject(mod)
  #convergence histograms
  ##NEW convergence histograms
  n_eff_beta<- as.data.frame(effectiveSize(codaList$Beta))
  colnames(n_eff_beta)<- c("value")
  n_eff_beta$parameter<- "beta"
  n_eff_sigma<- as.data.frame(effectiveSize(codaList$Omega[[1]]))
  colnames(n_eff_sigma)<- c("value")
  n_eff_sigma$parameter<- "correlation"
  neff<- rbind(n_eff_beta,n_eff_sigma)
  p<- ggplot(neff, aes(x=value, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth =50) + xlab("effective size") +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+
   ggtitle("Effective size for the parameters beta and coefficients of correlation matrix")
  plot(p)
  
  Rhat_beta<-as.data.frame(gelman.diag(codaList$Beta,multivariate=FALSE)$psrf)
  Rhat_beta$parameter<- "beta"
  Rhat_sigma<- as.data.frame(gelman.diag(codaList$Omega[[1]], multivariate=FALSE)$psrf)
  Rhat_sigma$parameter<- "correlation"
  Rhat<- rbind(Rhat_beta,Rhat_sigma)
  p2<- ggplot(Rhat, aes(x= Rhat$`Point est.`, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth =0.01) +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+ xlab("Rhat") +
   ggtitle("Rhat for the parameters beta and the coefficients of correlation matrix")
  plot(p2)
}

hm_conv(hm_mod)
```




Study of interactions

```{r hmsc study of interactions, include=FALSE,results=F}
metrics_hmsc<-function(Rho, comp=NULL,fac=NULL,only_env=T){
  #{
    if(!is.null(comp) & !is.null(fac)){
    fac_comp <- fac-comp
    TP_comp <- FN_comp <-TP_fac <- FN_fac <- FP <- TN <- wrong <- 0
    for(i in 1:(nrow(Rho)-1)){
      for(j in (i+1):ncol(Rho)){
        if(fac_comp[i,j]>0 & Rho[i,j] >0)
          TP_fac=TP_fac+1
        if(fac_comp[i,j]>0 & Rho[i,j] == 0)
          FN_fac=FN_fac+1
        if(fac_comp[i,j]==0 & Rho[i,j] == 0)
           TN=TN+1
        if(fac_comp[i,j]==0 & Rho[i,j] != 0)
           FP=FP+1
        if(fac_comp[i,j]< 0 & Rho[i,j] < 0)
          TP_comp=TP_comp+1
        if(fac_comp[i,j]<0 & Rho[i,j] == 0)
          FN_comp=FN_comp+1
        if((fac_comp[i,j]<0 & Rho[i,j] > 0) | (fac_comp[i,j]>0 & Rho[i,j] < 0))
          wrong=wrong+1
      }
    }
    
  }else{
    if(!is.null(comp)){
    TP_comp <- FN_comp <- FP <- TN <- wrong <- 0
    TP_fac <- FN_fac<-NULL
    for(i in 1:(nrow(Rho)-1)){
      for(j in (i+1):ncol(Rho)){
        if(comp[i,j]>0 & Rho[i,j] <0)
          TP_comp=TP_comp+1
        if(comp[i,j]>0 & Rho[i,j] >0)
          wrong=wrong+1
        if(comp[i,j]>0 & Rho[i,j] == 0)
          FN_comp=FN_comp+1
        if(comp[i,j]==0 & Rho[i,j] == 0)
          TN=TN+1
        if(comp[i,j]==0 & Rho[i,j] != 0)
          FP=FP+1
      }
    }
  #  }
  #  }
  }
  if(!is.null(fac)){
    
            TP_fac <- FN_fac <- FP <- TN <- wrong <- 0
            TP_comp <- FN_comp<-NULL
            for(i in 1:(nrow(Rho)-1)){
              for(j in (i+1):ncol(Rho)){
                   if(fac[i,j]>0 & Rho[i,j] >0)
                      TP_fac=TP_fac+1
                   if(fac[i,j]>0 & Rho[i,j] <0)
                      wrong = wrong+1
                   if(fac[i,j]>0 & Rho[i,j] == 0)
                      FN_fac=FN_fac+1
                   if(fac[i,j]==0 & Rho[i,j] == 0)
                      TN=TN+1
                   if(fac[i,j]==0 & Rho[i,j] != 0)
                      FP=FP+1
              }
            }
  }
  }  
  
  if(only_env){
    
      FP <- TN <- 0
      TP_fac <- FN_fac<-TP_comp <- FN_comp<-wrong<-NULL
         for(i in 1:(nrow(Rho)-1)){
            for(j in (i+1):nrow(Rho)){
                if(Rho[i,j] != 0)
                      FP=FP+1
                if(Rho[i,j] == 0)
                      TN=TN+1
              }
            }
      
  }
  success_env<-TN/(TN+FP)
  
  if(!is.null(TP_comp)){success_comp <- TP_comp/(TP_comp+FN_comp)}else{ success_comp = NULL}
  
  if(!is.null(TP_fac)) {success_fac <- TP_fac/(TP_fac+FN_fac)}else{ success_fac = NULL}
  
  list("FP"=FP,"TN"=TN,"TP_comp"=TP_comp,"FN_comp"=FN_comp,"TP_fac"=TP_fac,"FN_fac"=FN_fac,
       "wrong"=wrong,"success_env"=success_env,"success_comp"=success_comp,"success_fac"=success_fac)
}


hm_inter<-function(mod=hm_mod, nchains=2,nsamples = 1000, interact=diag(ns)){
  getOmega = function(a,r=1)
  return(crossprod(a$Lambda[[r]]))
  ns<-mod$ns
  nsamples<-mod$samples
  postOmega1 = array(unlist(lapply(mod$postList[[1]],getOmega)),c(ns,ns,mod$samples))
  postOmega2 = array(unlist(lapply(mod$postList[[2]],getOmega)),c(ns,ns,mod$samples))
  
  postOmega<-abind(postOmega1,postOmega2,along=3)
  postOmegaMean = apply(postOmega,c(1,2),mean)
  postOmegaUp=apply(postOmega,c(1,2),quantile,0.95)
  postOmegaLo=apply(postOmega,c(1,2),quantile,0.05)
  
  postR<-array(dim=c(ns,ns,nchains*nsamples))
  postT<-array(dim=c(ns,ns,nchains*nsamples))
  for(i in 1:dim(postOmega)[3]){
  postR[,,i]<-stats::cov2cor(postOmega[,,i])
  postT[,,i]<- -stats::cov2cor(solve(postOmega[,,i]+diag(ns)))
  }
  
  postRMean = apply(postR,c(1,2),mean)
  postRUp=apply(postR,c(1,2),quantile,0.95)
  postRLo=apply(postR,c(1,2),quantile,0.05)
  
  postTMean = apply(postT,c(1,2),mean)
  postTUp=apply(postT,c(1,2),quantile,0.95)
  postTLo=apply(postT,c(1,2),quantile,0.05)
  
  Toplot_R<-postRMean*(!(postRUp>0 & postRLo<0))
  Toplot_T<-postTMean*(!(postTUp>0 & postTLo<0))
  
  # Omegacor<- computeAssociations(m)
  # supportLevel<- 0.95
  # toPlot<- ((Omegacor[[1]]$support>supportLevel)+ (Omegacor[[1]]$support<(1-supportLevel))>0)*Omegacor[[1]]$mean
  # corrplot(toPlot, method="color", col=colorRampPalette(c("blue", "white", "red"))(200))
  
  par(mfrow=c(2,3),oma = c(1, 1, 1, 1))
  corrplot(cor(hm_mod$Y), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Correlation cor(Y)")
  corrplot(postRMean, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("R")
  corrplot(Toplot_R, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Plot only non zero value")
  corrplot(Toplot_T, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Partial correlation matrix")
  corrplot(interact, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("True interactions")
  
  return(list(Rho_sign=Toplot_R,Tau_sign=Toplot_T)) 
}

hm_mod_R<-hm_inter(hm_mod,nchains=2,nsamples = 1000)
h_metric_e5<-metrics_hmsc(hm_mod_R$Rho_sign)
h_metric_e5_p<-metrics_hmsc(hm_mod_R$Tau_sign)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


#prediction
#pred_hm<-simplify2array(predict(hm_mod,expected=F))
x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hm_mean <- apply(pred_hm, c(1,2), mean)
pred_hm_05 <- apply(pred_hm, c(1,2), quantile,0.05)
pred_hm_95 <- apply(pred_hm, c(1,2), quantile,0.95)


pred_hmsc<- list(pred_hm_mean=pred_hm_mean,pred_hm_05=pred_hm_05,pred_hm_95=pred_hm_95)

AUC_h_env<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_env<-c(AUC_h_env,auc(roc(pred_hm_mean[,i],factor(data[,i]))))


```




### Dimension reduction


```{r dimred env5, include=TRUE,echo=FALSE}
gjam_dim_red_5<-function(datab,ng=2500, burnin=500,name="./gjam_models/tmpdr.rda", regime="L"){
  ydata<-subset(datab, select = -env)
  xdata<-scale(poly(datab$env, 2))
  ns<- ncol(ydata)
  N<-ncol(ydata)-1
  n<-nrow(datab)
  colnames(xdata)<- c("env","env2")
  formula<- ~env + env2
  r<-3
  
  rl <-list(N=N, r=r)
  ml  <- list(ng = ng, burnin = burnin, typeNames = 'PA',reductList=rl,PREDICTX = F )
  if(regime=="L"){
    gjam_dr_mods<-load_object(name)
    mod_gjam_red_1<-gjam_dr_mods$m1
    mod_gjam_red_2<-gjam_dr_mods$m2
  }else{
      mod_gjam_red_1 <- gjam(formula, xdata, ydata, modelList = ml)
      mod_gjam_red_2 <- gjam(formula, xdata, ydata, modelList = ml)
      gjam_dr_mods<- list(m1=mod_gjam_red_1,m2=mod_gjam_red_2)
      save(gjam_dr_mods, file = name)
  }
  gjam_bs<- mcmc.list(mcmc(mod_gjam_red_1$chains$bgibbs[-(1:burnin),]),mcmc(mod_gjam_red_2$chains$bgibbsUn[-(1:burnin),]))
  gjam_sigma<- mcmc.list(mcmc(mod_gjam_red_1$chains$sgibbs[-(1:burnin),]),mcmc(mod_gjam_red_2$chains$sgibbs[-(1:burnin),]))
  n_eff_beta<- as.data.frame(effectiveSize(gjam_bs))
  colnames(n_eff_beta)<- c("value")
  n_eff_beta$parameter<- "beta"
  n_eff_sigma<- as.data.frame(effectiveSize(gjam_sigma))
  colnames(n_eff_sigma)<- c("value")
  n_eff_sigma$parameter<- "correlation"
  neff<- rbind(n_eff_beta,n_eff_sigma)
  p<- ggplot(neff, aes(x=value, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth = 100) + xlab("effective size") +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+
   ggtitle("Effective size for the parameters beta and coefficients of correlation matrix")
  
  plot(p)
  
  Rhat_beta<-as.data.frame(gelman.diag(gjam_bs, multivariate=FALSE)$psrf)
  Rhat_beta$parameter<- "beta"
  Rhat_sigma<- as.data.frame(gelman.diag(gjam_sigma, multivariate=FALSE)$psrf)
  Rhat_sigma$parameter<- "correlation"
  Rhat<- rbind(Rhat_beta,Rhat_sigma)
  p2<- ggplot(Rhat, aes(x= Rhat$`Point est.`, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth =0.1) +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+ xlab("Rhat") +
   ggtitle("Rhat for the parameters beta and the coefficients of correlation matrix")
  plot(p2)


  #gelman.plot(gjam_bs)
  #xyplot(gjam_bs)
  #traceplot(gjam_sigma)
  #gelman.plot(gjam_sigma)
  #xyplot(gjam_sigma)

  sgibbs<-abind(mod_gjam_red_1$chains$sgibbs[-(1:burnin),],mod_gjam_red_2$chains$sgibbs[-(1:burnin),],along=1)
  sigErrGibbs<-abind(mod_gjam_red_1$chains$sigErrGibbs[-(1:burnin)],mod_gjam_red_2$chains$sigErrGibbs[-(1:burnin)],along=1)
  kgibbs<-abind(mod_gjam_red_1$chains$kgibbs[-(1:burnin),],mod_gjam_red_2$chains$kgibbs[-(1:burnin),],along=1)
  sigma<-invsigma<-array(NA,dim=c(ns,ns,2*(ng-burnin)))
  
  
  #sgibbs<-mod_gjam_red$chains$sgibbs
  #sigErrGibbs<-mod_gjam_red$chains$sigErrGibbs
  #kgibbs<-mod_gjam_red$chains$kgibbs
  N<-mod_gjam_red_1$modelList$reductList$N
  r<-mod_gjam_red_1$modelList$reductList$r
  N_dim<-2*(ng-burnin)
  for(j in 1:N_dim){
    Z  <- matrix(sgibbs[j,],N,r)
    sigma[,,j] <- .expandSigma(sigErrGibbs[j], ns, Z = Z, kgibbs[j,], REDUCT = T) #sigma
    invsigma[,,j] <- invWbyRcpp(sigErrGibbs[j], Z[kgibbs[j,],]) #inverse sigma
  } 
  
  sigma_mean<-apply(sigma,c(1,2),mean) 
  sigma_q05<-apply(sigma,c(1,2),quantile,0.05) 
  sigma_q95<-apply(sigma,c(1,2),quantile,0.95) 
  Sigma_sign<--cov2cor(sigma_mean*(!(sigma_q95>0 & sigma_q05<0)))
  
  invsigma_mean<-apply(invsigma,c(1,2),mean) 
  invsigma_q05<-apply(invsigma,c(1,2),quantile,0.05) 
  invsigma_q95<-apply(invsigma,c(1,2),quantile,0.95) 
  INVSigma_sign<--cov2cor(sigma_mean*(!(invsigma_q95>0 & invsigma_q05<0)))
  x <- cbind(1, scale(poly(datab$env, 2)))
  #x<- xdata
  J<- ncol(datab) - 1
  
  bgibbspr<-abind(mod_gjam_red_1$chains$bgibbs[-(1:burnin),],mod_gjam_red_2$chains$bgibbs[-(1:burnin),],along=1)
  N_dim<-2*(ng-burnin)
  mu<-array(NA,dim=c(n,J,N_dim))
  for(k in 1:N_dim){
      for(j in 1:J){
    
         mu[,j,k] <- pnorm(x%*%bgibbspr[k,(3*(j-1)+1):(3*j)])
          
    }
  }
  
  return(list(Rho_sign_d=Sigma_sign,Tau_sign_d=INVSigma_sign,k=kgibbs, predict=mu, bchain=bgibbspr))
}

S<- gjam_dim_red_5(datab=sim_data$EnvEvenSp5,ng=10000, burnin=1000, name="./gjam_models/gjamDR5env.rda", regime="L")

g_dr_metric_e5<-metrics_gjam(S$Rho_sign_d)
g_dr_metric_e5_p<-metrics_gjam(S$Tau_sign_d)


##AUC
AUC_gdr_env<-vector()

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$EnvEvenSp5 
for(i in 1:(ncol(data)-1)) AUC_gdr_env<-c(AUC_gdr_env,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))

pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)

par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot(diag(5), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```


```{r fsdm env5, include=TRUE,echo=FALSE,warning=FALSE,message=FALSE}

predict_sdm<-function(datas){
  data_temp<-dataprep(datas) 
  df<-cbind(data_temp$X[,-1],data_temp$Y)
  names(df)[1:2]<- c("env","env2" )
  #predY<- as.data.frame(matrix(NA,nrow(data_temp$X),ncol(data_temp$Y)))
  predY<- data.frame()
  predBeta<- data.frame()
  #colnames(predBeta)<- c("low","high","mean","sp","beta")
  i<-1
  for(i in 1:ncol(data_temp$Y)){
    df_temp<-df[,c("env","env2",colnames(df)[i+2])]
    colnames(df_temp)<-c("env","env2","yval")
    probitMod <- glm(yval~ env + env2, data=df_temp, family=binomial(link="probit"))  # build the logit model
    #predicted <- predict(probitMod, df[,c("env","env2")], type="response")  # predict the probability scores
    predicted <- predict(probitMod, df[,c("env","env2")], type="link",se.fit = TRUE)  # predict the probability scores
    table_sdm<-as.data.frame(datas$env)
    colnames(table_sdm)<-c("xx")
    table_sdm$mean<-pnorm(predicted$fit)
    confidence <- .95
    score <- qnorm((confidence / 2) + .5)
    table_sdm$q_95<-pnorm(predicted$fit + score * predicted$se.fit)
    table_sdm$q_05<-pnorm(predicted$fit - score * predicted$se.fit)
    table_sdm$type<-"SDM"
    table_sdm$species<-i
    predY<- rbind(predY,table_sdm)
    tmp_ci<-confint(probitMod)
    predBeta_tmp<- as.data.frame(tmp_ci)
    names(predBeta_tmp)<- c("low", "high")
    predBeta_tmp$mean <- probitMod$coefficients
    predBeta_tmp$sp <- rep(i,3)
    predBeta_tmp$beta<- c("inter","env","env2")
    predBeta<- rbind(predBeta,predBeta_tmp)
  }
  
  predBeta$model<-"SDM"
  
  return(list(beta_sdm=predBeta,pred_sdm=predY))
}

sdm_env5<-predict_sdm(sim_data$EnvEvenSp5)


```



### Plot species responses





```{r function response to environnment env5, include=TRUE,echo=FALSE}
create_plot_response<- function(data, nsp=5,pred_gjam, pred_jsdm,pred_hmsc,gjam_dr,sdmpred){
  np<-nrow(data)
  nspecies<-nsp
  niche_optima  = seq(2, 98, length.out=nspecies)
  niche_breadth = 20
 
  #dataframe for fundamental niches
table_fundamental<-data.frame()

for(i in 1:nspecies){
  tmp<-data.frame(xx=0:100,niche=dnorm(0:100,mean=niche_optima[i],sd=niche_breadth)/dnorm(niche_optima[i],mean=niche_optima[i],sd=niche_breadth),species=i)
  table_fundamental<-rbind(table_fundamental,tmp)
}

######## JSDM
xx<-data$env

table_jsdm<-data.frame()
pred_j_mean<-pred_jsdm$pred_j_mean
pred_j_05<-pred_jsdm$pred_j_05
pred_j_95<-pred_jsdm$pred_j_95

  
for(i in 1:nspecies) {
  tmp<-data.frame(xx=xx,mean=pred_j_mean[,i],q_95=pred_j_95[,i],q_05=pred_j_05[,i],type=rep("CM",np),species=rep(i,np))
  table_jsdm<-rbind(table_jsdm,tmp)
  
}
######## GJAM
table_gjam<-data.frame()

pred_gj_mean<-pred_gjam$pred_gj_mean
pred_gj_95<-pred_gjam$pred_gj_95
pred_gj_05<-pred_gjam$pred_gj_05

for(i in 1:nspecies) {
  tmp<-data.frame(xx=xx,mean=pred_gj_mean[,i],q_95=pred_gj_95[,i],q_05=pred_gj_05[,i],type=rep("GJAM",np),species=rep(i,np))
  table_gjam<-rbind(table_gjam,tmp)
}


######## GJAM_DR
table_gjam_dr<-data.frame()

pred_gj_dr_mean<-pred_gjam_dr$pred_gj_dr_mean
pred_gj_dr_95<-pred_gjam_dr$pred_gj_dr_95
pred_gj_dr_05<-pred_gjam_dr$pred_gj_dr_05

for(i in 1:nspecies) {
  tmp<-data.frame(xx=xx,mean=pred_gj_dr_mean[,i],q_95=pred_gj_dr_95[,i],q_05=pred_gj_dr_05[,i],type=rep("DR-GJAM",np),species=rep(i,np))
  table_gjam_dr<-rbind(table_gjam_dr,tmp)
}


#HMSC
table_hmsc<-data.frame()
pred_hm_mean<-pred_hmsc$pred_hm_mean
pred_hm_95<-pred_hmsc$pred_hm_95
pred_hm_05<-pred_hmsc$pred_hm_05
  
for(i in 1:nspecies) {
  tmp<-data.frame(xx=xx,mean=pred_hm_mean[,i],q_95=pred_hm_95[,i],q_05=pred_hm_05[,i],type=rep("HMSC",np),species=rep(i,np))
  table_hmsc<-rbind(table_hmsc,tmp)
}
  
#SDM 
table_sdm<-sdmpred

#table for predictions
table<-rbind(table_jsdm,table_gjam,table_gjam_dr,table_hmsc,table_sdm)

#table for observations
Y_data = subset(data, select = -env)
table_obs<-data.frame()

for(i in 1:nspecies){
  tmp<-data.frame(xx=xx,obs=Y_data[,i],species=rep(i,np))
  table_obs<-rbind(table_obs,tmp)
}


######## FIRST TYPE OF PLOT
# 1 plot for each species, so one figure with 5 plots, in total 3 figures, one for each model
p_0<-list()
#SDM
for(i in 1:nsp)
local({
  i<-i
  tmp<-table_sdm[which(table_sdm$species==i),]
  tmp_obs<-table_obs[which(table_obs$species==i),]
  tmp_fund<-table_fundamental[which(table_fundamental$species==i),]
  g<<-ggplot()+
    geom_ribbon(aes(x=tmp$xx,ymin=tmp$q_05,ymax=tmp$q_95),alpha=0.5)+
    geom_line(aes(x=tmp$xx,y=tmp$mean,color = "Predicted probability"),lwd=1.5)+
    geom_point(aes(x=tmp_obs$xx,y=tmp_obs$obs),col="#000066",size=0.5) +xlab("Environmental gradient")+ylab("Probability of presence")+
    geom_line(data=tmp_fund,aes(x=tmp_fund$xx,y=tmp_fund$niche,color = "Fundamental niche"),lwd=1)+
    labs(title=paste0("SDM, Species ",i))+
    scale_color_manual(name = c("Legend"), values = c("Predicted probability" = "#FF6666","Fundamental niche"="#9999FF"))+theme_bw()+ theme(plot.title = element_text(hjust = 0.5))
  
    p_0<<-list.append(p_0,g)
    assign(paste0("p",i), g, pos =1)
})

if(nsp==5){
  grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
} else{ p_0}







p_1<-list()
#jsdm 
for(i in 1:nsp)
local({
  i<-i
  tmp<-table_jsdm[which(table_jsdm$species==i),]
  tmp_obs<-table_obs[which(table_obs$species==i),]
  tmp_fund<-table_fundamental[which(table_fundamental$species==i),]
  g<<-ggplot()+
    geom_ribbon(aes(x=tmp$xx,ymin=tmp$q_05,ymax=tmp$q_95),alpha=0.5)+
    geom_line(aes(x=tmp$xx,y=tmp$mean,color = "Predicted probability"),lwd=1.5)+
    geom_point(aes(x=tmp_obs$xx,y=tmp_obs$obs),col="#000066",size=0.5) +xlab("Environmental gradient")+ylab("Probability of presence")+
    geom_line(data=tmp_fund,aes(x=tmp_fund$xx,y=tmp_fund$niche,color = "Fundamental niche"),lwd=1)+
    labs(title=paste0("CM, Species ",i))+
    scale_color_manual(name = c("Legend"), values = c("Predicted probability" = "#FF6666","Fundamental niche"="#9999FF"))+theme_bw()+ theme(plot.title = element_text(hjust = 0.5))
  
    p_1<<-list.append(p_1,g)
    assign(paste0("p",i), g, pos =1)
})

if(nsp==5){
  grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
} else{ p_1}







#gjam
p_2<-list()
for(i in 1:nsp)
local({
  i<-i
  tmp<-table_gjam[which(table_gjam$species==i),]
  tmp_obs<-table_obs[which(table_obs$species==i),]
  tmp_fund<-table_fundamental[which(table_fundamental$species==i),]
  g<<-ggplot()+
    geom_ribbon(aes(x=tmp$xx,ymin=tmp$q_05,ymax=tmp$q_95),alpha=0.5)+
    geom_line(aes(x=tmp$xx,y=tmp$mean,color = "Predicted probability"),lwd=1.5)+
    geom_point(aes(x=tmp_obs$xx,y=tmp_obs$obs),col="#000066",size=0.5) +xlab("Environmental gradient")+ylab("Probability of presence")+
    geom_line(data=tmp_fund,aes(x=tmp_fund$xx,y=tmp_fund$niche,color = "Fundamental niche"),lwd=1)+
    labs(title=paste0("GJAM, Species ",i))+
    scale_color_manual(name = c("Legend"), values = c("Predicted probability" = "#FF6666","Fundamental niche"="#9999FF"))+theme_bw()+ theme(plot.title = element_text(hjust = 0.5))

  p_2<<-list.append(p_2,g)
  assign(paste0("p",i), g, pos =1)
})

if (nsp==5){
  grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
}else{ 
  p_2
  }

#gjam_dr
p_2_1<-list()
for(i in 1:nsp)
local({
  i<-i
  tmp<-table_gjam_dr[which(table_gjam_dr$species==i),]
  tmp_obs<-table_obs[which(table_obs$species==i),]
  tmp_fund<-table_fundamental[which(table_fundamental$species==i),]
  g<<-ggplot()+
    geom_ribbon(aes(x=tmp$xx,ymin=tmp$q_05,ymax=tmp$q_95),alpha=0.5)+
    geom_line(aes(x=tmp$xx,y=tmp$mean,color = "Predicted probability"),lwd=1.5)+
    geom_point(aes(x=tmp_obs$xx,y=tmp_obs$obs),col="#000066",size=0.5) +xlab("Environmental gradient")+ylab("Probability of presence")+
    geom_line(data=tmp_fund,aes(x=tmp_fund$xx,y=tmp_fund$niche,color = "Fundamental niche"),lwd=1)+
    labs(title=paste0("DR-GJAM, Species ",i))+
    scale_color_manual(name = c("Legend"), values = c("Predicted probability" = "#FF6666","Fundamental niche"="#9999FF"))+theme_bw()+ theme(plot.title = element_text(hjust = 0.5))

  p_2_1<<-list.append(p_2_1,g)
  assign(paste0("p",i), g, pos =1)
})

if (nsp==5){
  grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
}else{ 
  p_2_1
  }



#hmsc
p_3<-list()
for(i in 1:nsp)
local({
  i<-i
  tmp<-table[which(table_hmsc$species==i),]
  tmp_obs<-table_obs[which(table_obs$species==i),]
  tmp_fund<-table_fundamental[which(table_fundamental$species==i),]
  g<<-ggplot()+
    geom_ribbon(aes(x=tmp$xx,ymin=tmp$q_05,ymax=tmp$q_95),alpha=0.5)+
    geom_line(aes(x=tmp$xx,y=tmp$mean,color = "Predicted probability"),lwd=1.5)+
    geom_point(aes(x=tmp_obs$xx,y=tmp_obs$obs),col="#000066",size=0.5) +xlab("Environmental gradient")+ylab("Probability of presence")+
    geom_line(data=tmp_fund,aes(x=tmp_fund$xx,y=tmp_fund$niche,color = "Fundamental niche"),lwd=1)+
    labs(title=paste0("HMSC, Species ",i))+
    scale_color_manual(name = c("Legend"), values = c("Predicted probability" = "#FF6666","Fundamental niche"="#9999FF"))+ theme(plot.title = element_text(hjust = 0.5))
   p_3<<-list.append(p_3,g)
  assign(paste0("p",i), g, pos =1)
})

#x11()
if (nsp==5){
  grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
}else{ 
  p_3
}




########SECOND TYPE OF PLOT
p_4<-list()
for(i in 1:nsp)
local({
  i<-i
  tmp<-table[which(table$species==i),]
  tmp_obs<-table_obs[which(table_obs$species==i),]
  tmp_fund<-table_fundamental[which(table_fundamental$species==i),]
  g<<-ggplot()+
    geom_ribbon(aes(x=tmp$xx,ymin=tmp$q_05,ymax=tmp$q_95,col=as.factor(tmp$type)),alpha=0.5)+
    geom_line(aes(x=tmp$xx,y=tmp$mean,col=as.factor(tmp$type)),lwd=1.5)+
    geom_point(aes(x=tmp_obs$xx,y=tmp_obs$obs),col="#000066",size=0.5) +xlab("Environmental gradient")+ylab("Probability of presence")+
    geom_line(data=tmp_fund,aes(x=tmp_fund$xx,y=tmp_fund$niche,color = "Fundamental niche"),lwd=1)+
    labs(title=paste0("All models, Species ",i))+
    scale_color_manual(name = c("Legend"), values = c("SDM" = "#56B4E9","CM" = "#FF6666","GJAM" = "#66CC99","DR-GJAM" = "#FFFF10","HMSC" = "#FFB266","Fundamental niche"="#9999FF")) +theme_bw()+ theme(plot.title = element_text(hjust = 0.5))
  p_4<<-list.append(p_4,g)
  assign(paste0("p",i), g, pos =1)
})

if (nsp==5){
  grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
}else{ 
  p_4
  }
#x11()
#grid.arrange(p1,p2,p3,p4,p5,nrow=ceiling(nspecies/2))
  
}

create_plot_response(data=sim_data$EnvEvenSp5, nsp=5,pred_gjam,pred_jsdm= pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_env5$pred_sdm)

```




## Summary plots


```{r beta coefs env5, include=TRUE,echo=FALSE}
prepare_table<- function(datab,name,class){
  data_new<-as.data.frame(datab) 
  colnames(data_new) <- c("inter","env","env2")
  data_new$sp<-as.character(seq.int(nrow(data_new)))
  data_out<- melt(data_new, id=c("sp"), variable_name = "beta")
  colnames(data_out)[colnames(data_out)=="value"] <-name
  data_out$model<-class
  return(data_out)
}

########GJAM####################################################
prepare_beta_gjam<-function(datab,name,class){
  beta_out<-melt(datab)
  beta_out$rn<-rownames(beta_out)
  beta_out$sp<- as.character(as.numeric(substr(beta_out$rn,3,4)))
  beta_out$beta<- sapply(beta_out$rn,function(x) strsplit(x,"_")[[1]][2])
  colnames(beta_out)[colnames(beta_out)=="value"] <-name
  beta_out$model<- class
  beta_out$beta[which(beta_out$beta=="intercept")] <-"inter"
  return(beta_out[,c("beta","sp","model",name)])
}



####hmsc

prepare_beta_hmsc<-function(datab,name,class,vcol,vrow){
  colnames(datab)<- vcol
  rownames(datab)<-vrow
  beta_out<-melt(datab,value.name = "mean",varnames=c('beta', 'sp'))
  beta_out$sp<- as.character(as.numeric(substr(beta_out$sp,4,5)))
  colnames(beta_out)[colnames(beta_out)=="value"] <-name
  beta_out$model<- class
  beta_out$beta<-as.character(beta_out$beta)
  beta_out$beta[which(beta_out$beta=="(Intercept)")] <-"inter"
  colnames(beta_out)[colnames(beta_out)=="value"] <-name
  return(beta_out[,c("beta","sp","model",name)])
}



create_beta_plot<- function(gjmod, jsdmmod, hmmod, gjam_dr_bchain,sdmbeta){
  nsp<-hmmod$ns
  beta_mean<-prepare_table(jsdmmod$mean$B,name="mean",class="CM")
  beta_q25<-prepare_table(datab=jsdmmod$q2.5$B,name="low",class="CM")
  beta_q97<-prepare_table(jsdmmod$q97.5$B,name="high",class="CM")
  beta_jsdm<-merge(beta_mean,beta_q25, by=c("beta","sp","model"))
  beta_jsdm<-merge(beta_jsdm,beta_q97,by=c("beta","sp","model"))

########GJAM###################################################
  gjmod_1<-gjmod$m1
  beta_mean_raw<- apply(gjmod_1$chains$bgibbs,2,mean)
  beta_q25_raw<- apply(gjmod_1$chains$bgibbs,2,quantile,0.025)
  beta_q97_raw<- apply(gjmod_1$chains$bgibbs,2,quantile,0.975)
  
  beta_mean<- prepare_beta_gjam(beta_mean_raw,"mean", "GJAM")
  beta_q25<- prepare_beta_gjam(beta_q25_raw,"low", "GJAM")
  beta_q97<- prepare_beta_gjam(beta_q97_raw,"high", "GJAM")
  
  beta_gjam<-merge(beta_mean,beta_q25, by=c("beta","sp","model"))
  beta_gjam<-merge(beta_gjam,beta_q97,by=c("beta","sp","model"))

  
########GJAM_DR###################################################
gjdr_bchain<-gjam_dr_bchain
gjdr_bchain<-S$bchain
beta_mean_raw<- apply(gjdr_bchain,2,mean)
beta_q25_raw<- apply(gjdr_bchain,2,quantile,0.025)
beta_q97_raw<- apply(gjdr_bchain,2,quantile,0.975)

beta_mean<- prepare_beta_gjam(beta_mean_raw,"mean", "DR-GJAM")
beta_q25<- prepare_beta_gjam(beta_q25_raw,"low", "DR-GJAM")
beta_q97<- prepare_beta_gjam(beta_q97_raw,"high", "DR-GJAM")

beta_gjam_dr<-merge(beta_mean,beta_q25, by=c("beta","sp","model"))
beta_gjam_dr<-merge(beta_gjam_dr,beta_q97,by=c("beta","sp","model"))



####hmsc
  
  beta_hm<-array(NA,dim=c(hmmod$nc,hmmod$ns,2*hmmod$samples)) #2 is nchains
  for(k in 1:(2*hmmod$samples)){
      if(k<=hmmod$samples){beta_hm[,,k] <- hmmod$postList[[1]][[k]]$Beta
      }else {beta_hm[,,k] <- hmmod$postList[[2]][[k-hmmod$samples]]$Beta}
  
  }
  beta_mean_raw<- apply(beta_hm,c(1,2),mean)
  beta_q25_raw<- apply(beta_hm,c(1,2),quantile,0.025)
  beta_q97_raw<- apply(beta_hm,c(1,2),quantile,0.975)

  
  beta_mean<- prepare_beta_hmsc(datab=beta_mean_raw,name="mean", class="HMSC",vcol=hmmod$spNames,vrow=hmmod$covNames)
  beta_q25<- prepare_beta_hmsc(beta_q25_raw,"low", "HMSC",vcol=hmmod$spNames,vrow=hmmod$covNames)
  beta_q97<- prepare_beta_hmsc(beta_q97_raw,"high", "HMSC",vcol=hmmod$spNames,vrow=hmmod$covNames)
  
  beta_hmsc<-merge(beta_mean,beta_q25, by=c("beta","sp","model"))
  beta_hmsc<-merge(beta_hmsc,beta_q97,by=c("beta","sp","model"))
  

  
  data_beta<-rbind(beta_gjam,beta_gjam_dr,beta_jsdm,beta_hmsc,sdmbeta)
  data_beta$name<- "Specie"
  data_beta$name<- paste(data_beta$name,data_beta$sp)
  data_beta[, 'model'] <- as.factor(data_beta[, 'model'])
  
  
if(nsp==5){
p <- ggplot(data_beta, aes(mean, beta, colour = model))
q<- p + geom_point( size = 2) +xlab("Value")+ylab("Coefficients")+scale_y_discrete(
        labels=c("inter" =expression(beta[0]),"env" = expression(beta[1]),"env2" = expression(beta[2])))+
  geom_errorbarh(aes(xmax = high, xmin = low, height = .3))+ facet_grid(name ~.,scales = "free")+
  geom_vline(aes(xintercept = 0),size = 0.2, colour = "red") +theme_bw() + theme(strip.text.x = element_text(size = 10, colour = "black"),plot.title = element_text(hjust = 0.5),legend.position = "top") +
   ggtitle("Comparison of the estimated covariates coefficiens") 
q
}else{
for(i in 1:nsp){
  tmp<-data_beta[which(data_beta$sp==i),]
  p <- ggplot(tmp, aes(mean, beta, colour = model))
  q<- p + geom_point( size = 2) +xlab("Value")+ylab("Coefficients")+scale_y_discrete(
        labels=c("inter" =expression(beta[0]),"env" = expression(beta[1]),"env2" = expression(beta[2])))+
  geom_errorbarh(aes(xmax = high, xmin = low, height = .3))+
  geom_vline(aes(xintercept = 0),size = 0.2, colour = "red") +theme_bw()+ theme(strip.text.x = element_text(size = 10, colour = "black"),plot.title = element_text(hjust = 0.5),legend.position = "top") +
   ggtitle(paste("Comparison of the estimated covariates coefficiens for specie ",i)) 
print(q)
 }
}
}

#######Sys.setenv('R_MAX_VSIZE'=32000000000)

create_beta_plot(load_object("./gjam_models/gjam5env.rda"),me5,hmmod=load_object("./new_HMmodels/hm5env.rda"),S$bchain,sdm_env5$beta_sdm)

```



```{r all models env5, include=TRUE}

ALL3<-function(jsdm_mod,gjam_mod,hmsc_mod,interact=diag(5)){
 par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
  corrplot(jsdm_mod, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("R  CM ")
  corrplot(gjam_mod, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("R GJAM")
  corrplot(hmsc_mod, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("R HMSC")
  corrplot(interact, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("True interactions")
}
ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,diag(5))

```



```{r all models tau env5, include=TRUE}

ALL4<-function(jsdm_mod,gjam_mod,hmsc_mod,interact=diag(5)){
 par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
  corrplot(jsdm_mod, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Partial correlation  CM ")
  corrplot(gjam_mod, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Partial correlation GJAM")
  corrplot(hmsc_mod, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Partial correlation HMSC")
  corrplot(interact, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("True interactions")
}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,diag(5))

```





## Environmental filtering 10 species





### JSDM





```{r load_m en10,include=TRUE, echo=FALSE}
me10 <- load_object("model-2019-04-10-08-26-20.rda")
#load("model-2019-04-09-19-02-16.rda")
summary(me10)
jsdm_conv(me10)
me10$mcmc.info[1:7]

j_metric_e10<-metrics_jsdm((!me10$overlap0$Rho)*me10$mean$Rho)
j_metric_e10_p<-metrics_jsdm(jsdm_tau(me10)$Tau_sign)

cat("Success rate ")
j_metric_e10$success_env

data<-sim_data$EnvEvenSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

##########################################################################################
#Tau<-solve
#Tau_n<-to_prec(me10$mean$Tau)
#Tau_k<-Tau_n*(!(model$q97.5$Tau>0 & model$q2.5$Tau<0))

plot_cor_jsdm<-function(mod,y,interact=diag(ncol(y))){
  par(mfrow=c(2,4),oma = c(3, 1, 2, 1))
  corrplot(cor(y), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Correlation cor(Y)")
  corrplot(mod$mean$EnvRho, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("EnvRho")
  corrplot(mod$mean$EnvRho*(!mod$overlap0$EnvRho), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("EnvRho signif")
  corrplot(mod$mean$Rho, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Rho")
  corrplot(mod$mean$Rho*(!mod$overlap0$Rho), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("Rho signif")
  corrplot(interact, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
  title("True interactions")
}

#plot_cor_jsdm(me10,data$Y)
###Correlation
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =me10$mean$Rho*(!me10$overlap0$Rho)) 
mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(me5)$Tau_sign) 

##Prediction
# pred_j<-pnorm(predict_y_jsdm(me10))
# pred_j_mean <- apply(pred_j, 1:2, mean)
# pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
# pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_j<-array(NA,dim=c(data$n,data$J,me10$mcmc.info$n.samples))
for(i in 1:me10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(me10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)
  

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_env<-c(AUC_j_env,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```





### Gjam




```{r gjam en10,include=TRUE,echo=FALSE}
data<-sim_data$EnvEvenSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam10env.rda")
gjam_mod<-load_gjam(data,it=10000,1000,name="./gjam_models/gjam10env.rda")
g_metric_e10<-metrics_gjam(gjam_mod$Rho_sign)
g_metric_e10_p<-metrics_gjam(gjam_mod$Tau_sign)
cat("Success rate ")
g_metric_e10$success_env
###Correlation
mod_list_Rho<-list.append(mod_list_Rho,gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau,gjam=gjam_mod$Tau_sign) 
##Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

for(i in 1:(ncol(data)-1)) AUC_g_env<-c(AUC_g_env,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)
```

### HMSC


```{r hmsc en10, include=TRUE, echo=FALSE}
data<-sim_data$EnvEvenSp10
hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm10env.rda" )

hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod)

h_metric_e10<-metrics_hmsc(hm_mod_R$Rho_sign)
h_metric_e10_p<-metrics_hmsc(hm_mod_R$Tau_sign)

mod_list_Rho<-list.append(mod_list_Rho, hmsc=hm_mod_R$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, hmsc=hm_mod_R$Tau_sign) 


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_env<-c(AUC_h_env,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```




### Dimension reduction gjam 




```{r dim red  env10, include=TRUE, echo=FALSE}

gjam_dim_red<-function(datab,ng=2500, burnin=500,r=1, name="./gjam_models/gjamDR5env.rda", regime="F"){
  ydata<-subset(datab, select = -env)
  xdata<-scale(poly(datab$env, 2))
  ns<- ncol(ydata)
  n<-nrow(datab)
  N<-ncol(ydata)-1
  colnames(xdata)<- c("env","env2")
  formula<- ~env + env2
  if (r==1){
    rseq<-seq(1,N,by=2)
    print(rseq)
    DIC_array<-array(NA,dim=length(rseq)-2)
    RSMPE_array<-array(NA,dim=length(rseq)-2)
    for (j in (2:(length(rseq)-1))){
      rl <-list(N=N, r=rseq[j])
      ml  <- list(ng = ng, burnin = burnin, typeNames = 'PA',reductList=rl, PREDICTX = F )
      mod_gjam_c <- gjam(formula, xdata, ydata, modelList = ml)
      DIC_array[j-1]<-mod_gjam_c$fit$DIC
      RSMPE_array[j-1]<-mod_gjam_c$fit$rmspeAll
    }
    r<- rseq[which.min(RSMPE_array)+1]
    print(DIC_array)
  }
  
  rl <-list(N=N, r=r)
  ml  <- list(ng = ng, burnin = burnin, typeNames = 'PA',reductList=rl)
  if(regime=="L"){
    gjam_dr_mods<-load_object(name)
    mod_gjam_red_1<-gjam_dr_mods$m1
    mod_gjam_red_2<-gjam_dr_mods$m2
  }else{
      mod_gjam_red_1 <- gjam(formula, xdata, ydata, modelList = ml)
      mod_gjam_red_2 <- gjam(formula, xdata, ydata, modelList = ml)
      gjam_dr_mods<- list(m1=mod_gjam_red_1,m2=mod_gjam_red_2)
      save(gjam_dr_mods, file = name)
  }
  gjam_bs<- mcmc.list(mcmc(mod_gjam_red_1$chains$bgibbsUn[-(1:burnin),]),mcmc(mod_gjam_red_2$chains$bgibbsUn[-(1:burnin),]))
  gjam_sigma<- mcmc.list(mcmc(mod_gjam_red_1$chains$sgibbs[-(1:burnin),]),mcmc(mod_gjam_red_2$chains$sgibbs[-(1:burnin),]))
  n_eff_beta<- as.data.frame(effectiveSize(gjam_bs))
  colnames(n_eff_beta)<- c("value")
  n_eff_beta$parameter<- "beta"
  n_eff_sigma<- as.data.frame(effectiveSize(gjam_sigma))
  colnames(n_eff_sigma)<- c("value")
  n_eff_sigma$parameter<- "correlation"
  neff<- rbind(n_eff_beta,n_eff_sigma)
  p<- ggplot(neff, aes(x=value, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth = 50) + xlab("effective size") +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+
   ggtitle("Effective size for the parameters beta and coefficients of correlation matrix")
  plot(p)
  
  Rhat_beta<-as.data.frame(gelman.diag(gjam_bs, multivariate=FALSE)$psrf)
  Rhat_beta$parameter<- "beta"
  Rhat_sigma<- as.data.frame(gelman.diag(gjam_sigma, multivariate=FALSE)$psrf)
  Rhat_sigma$parameter<- "correlation"
  Rhat<- rbind(Rhat_beta,Rhat_sigma)
  p2<- ggplot(Rhat, aes(x= Rhat$`Point est.`, color=parameter,fill=parameter)) +
     geom_histogram( alpha=0.4, position="identity",binwidth =0.1) +
    scale_color_brewer(palette="Dark2")+scale_fill_brewer(palette="Dark2")+ xlab("Rhat") +
   ggtitle("Rhat for the parameters beta and the coefficients of correlation matrix")
  plot(p2)

  #gelman.plot(gjam_bs)
  #xyplot(gjam_bs)
  #traceplot(gjam_sigma)
  # hist(effectiveSize(gjam_sigma), main="ess(sigma)",lwd=2,col=gray(.6),breaks = 50)
  # hist(gelman.diag(gjam_sigma,multivariate=FALSE)$psrf,lwd=2,col=gray(.6), main="psrf(sigma)",breaks = 50)
  #gelman.plot(gjam_sigma)
  #xyplot(gjam_sigma)
  sgibbs<-abind(mod_gjam_red_1$chains$sgibbs[-(1:burnin),],mod_gjam_red_2$chains$sgibbs[-(1:burnin),],along=1)
  sigErrGibbs<-abind(mod_gjam_red_1$chains$sigErrGibbs[-(1:burnin)],mod_gjam_red_2$chains$sigErrGibbs[-(1:burnin)],along=1)
  kgibbs<-abind(mod_gjam_red_1$chains$kgibbs[-(1:burnin),],mod_gjam_red_2$chains$kgibbs[-(1:burnin),],along=1)
  sigma<-invsigma<-array(NA,dim=c(ns,ns,2*(ng-burnin)))
  #.expandSigmaChains(snames, sgibbs, otherpar, simIndex=simIndex, sigErrGibbs, kgibbs, REDUCT)
  sigma<-invsigma<-array(NA,dim=c(ns,ns,2*(ng-burnin)))
  
  # sgibbs<-mod_gjam_red$chains$sgibbs
  # sigErrGibbs<-mod_gjam_red$chains$sigErrGibbs
  # kgibbs<-mod_gjam_red$chains$kgibbs
  N<-mod_gjam_red_1$modelList$reductList$N
  r<-mod_gjam_red_1$modelList$reductList$r
  N_dim<-2*(ng-burnin)
  for(j in 1:N_dim){
    Z  <- matrix(sgibbs[j,],N,r)
    sigma[,,j] <- .expandSigma(sigErrGibbs[j], ns, Z = Z, kgibbs[j,], REDUCT = T) #sigma
    invsigma[,,j] <- invWbyRcpp(sigErrGibbs[j], Z[kgibbs[j,],]) #inverse sigma
  } 
  sigma_mean<-apply(sigma,c(1,2),mean) 
  sigma_q05<-apply(sigma,c(1,2),quantile,0.05) 
  sigma_q95<-apply(sigma,c(1,2),quantile,0.95) 
  Sigma_sign<--cov2cor(sigma_mean*(!(sigma_q95>0 & sigma_q05<0)))
  
  invsigma_mean<-apply(invsigma,c(1,2),mean) 
  invsigma_q05<-apply(invsigma,c(1,2),quantile,0.05) 
  invsigma_q95<-apply(invsigma,c(1,2),quantile,0.95) 
  INVSigma_sign<--cov2cor(sigma_mean*(!(invsigma_q95>0 & invsigma_q05<0)))
  x <- cbind(1, scale(poly(datab$env, 2)))
  J<- ncol(datab) - 1
  bgibbspr<-abind(mod_gjam_red_1$chains$bgibbs[-(1:burnin),],mod_gjam_red_2$chains$bgibbs[-(1:burnin),],along=1)
  N_dim<-2*(ng-burnin)
  mu<-array(NA,dim=c(n,J,N_dim))
  for(k in 1:N_dim){
      for(j in 1:J){
    
         mu[,j,k] <- pnorm(x%*%bgibbspr[k,(3*(j-1)+1):(3*j)])
          
    }
  }
  
  return(list(Rho_sign_d=Sigma_sign,Tau_sign_d=INVSigma_sign,k=kgibbs, predict=mu, bchain=bgibbspr))
}
#r-opt=7
#when you want to find opt r set r==1 , when want specific r set r==k
S<- gjam_dim_red(sim_data$EnvEvenSp10,ng=10000, burnin=1000,r=7, name="./gjam_models/gjamDR10env.rda", regime="L")

g_dr_metric_e10<-metrics_gjam(S$Rho_sign_d)
g_dr_metric_e10_p<-metrics_gjam(S$Tau_sign_d)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$EnvEvenSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_env<-c(AUC_gdr_env,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))

pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)




par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(diag(10), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```







### Summary plots for models





```{r all models rho env10, include=TRUE,warning=FALSE,message=FALSE}

sdm_env10<-predict_sdm(sim_data$EnvEvenSp10)


create_beta_plot(load_object("./gjam_models/gjam10env.rda"),me10,load_object("./new_HMmodels/hm10env.rda"), S$bchain,sdm_env10$beta_sdm)
#data, nsp=5,pred_gjam, pred_jsdm,pred_hmsc 
create_plot_response(data=sim_data$EnvEvenSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_env10$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,diag(10))

```




```{r all models tau env10, include=TRUE}


ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,diag(10))

```







## Environmental filtering 20 species





### JSDM

```{r load_m en20,include=FALSE}
me20 <- load_object("model-2019-04-11-19-06-02.rda")
#load("model-2019-04-09-19-02-16.rda")
summary(me20)

me20$mcmc.info[1:7]

jsdm_conv(me20)

j_metric_e20<-metrics_jsdm((!me20$overlap0$Rho)*me20$mean$Rho)
j_metric_e20_p<-metrics_jsdm(jsdm_tau(me20)$Tau_sign)

cat("Success rate ")
j_metric_e20$success_env

data<-sim_data$EnvEvenSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

##########################################################################################

plot_cor_jsdm(me20,data$Y)

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =me20$mean$Rho*(!me20$overlap0$Rho)) 
mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(me20)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,me20$mcmc.info$n.samples))
for(i in 1:me20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(me20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)
  


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_env<-c(AUC_j_env,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```


### Gjam

```{r gjam en20,include=TRUE,echo=FALSE}

data<-sim_data$EnvEvenSp20
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam20env.rda")
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam20env.rda")
g_metric_e20<-metrics_gjam(gjam_mod$Rho_sign)
g_metric_e20_p<-metrics_gjam(gjam_mod$Tau_sign)
cat(" ")
cat(sprintf("Success rate env: %s\n", round(metrics_gjam(gjam_mod$Rho_sign)$success_env,3)))

mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

for(i in 1:(ncol(data)-1)) AUC_g_env<-c(AUC_g_env,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

```


```{r hmsc en20, include=TRUE, echo=FALSE}

data<-sim_data$EnvEvenSp20
hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm20env.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod)

h_metric_e20<-metrics_hmsc(hm_mod_R$Rho_sign)
h_metric_e20_p<-metrics_hmsc(hm_mod_R$Tau_sign)

cat("Success score ")
h_metric_e20$success_env
cat(" ")
cat(sprintf("Success rate non-interacting: %s\n", round(metrics_hmsc(hm_mod_R$Rho_sign)$success_env,3)))

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_env<-c(AUC_h_env,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```



```{r dim red  env20, include=TRUE, echo=FALSE}

#r-opt=15
S<- gjam_dim_red(sim_data$EnvEvenSp20,ng=10000, burnin=1000,r=15, name="./gjam_models/gjamDR20env.rda", regime="L")
g_dr_metric_e20<-metrics_gjam(S$Rho_sign_d)
g_dr_metric_e20_p<-metrics_gjam(S$Tau_sign_d)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$EnvEvenSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_env<-c(AUC_gdr_env,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))

pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)



par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(diag(20), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




###Summary plots





```{r all models env20, include=TRUE,warning=FALSE,message=FALSE}

sdm_env20<-predict_sdm(sim_data$EnvEvenSp20)


create_beta_plot(load_object("./gjam_models/gjam20env.rda"),me20,load_object("./new_HMmodels/hm20env.rda"),S$bchain,sdm_env20$beta_sdm)

create_plot_response(sim_data$EnvEvenSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc ,pred_gjam_dr,sdm_env20$pred_sdm)


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,diag(20))

```




```{r all models tau env20, include=TRUE}

ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,diag(20))

```





## Environmental filtering + Facilitation dense 5 species





### JSDM

```{r load_m facd5,include=FALSE}
#mfd5 <- load_object("model-2019-04-11-19-35-11.rda")
mfd5 <- load_object("model-jsdm-2019-05-06-18-41-20.rda")
summary(mfd5)
#mfd5$Rhat
jsdm_conv(mfd5)
mfd5$mcmc.info[1:7]

j_metric_facDense5<-metrics_jsdm((!mfd5$overlap0$Rho)*mfd5$mean$Rho,fac = fac_inter[[4]],only_env = F)
j_metric_facDense5_p<-metrics_jsdm(jsdm_tau(mfd5)$Tau_sign,fac = fac_inter[[4]],only_env = F)

data<-sim_data$FacDenseSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

##########################################################################################
#Tau<-solve
#Tau_n<-to_prec(me10$mean$Tau)
#Tau_k<-Tau_n*(!(model$q97.5$Tau>0 & model$q2.5$Tau<0))

#plot_cor_jsdm(mfd5,data$Y,fac_inter[[4]])

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mfd5$mean$Rho*(!mfd5$overlap0$Rho)) 
 mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mfd5)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,mfd5$mcmc.info$n.samples))
for(i in 1:mfd5$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mfd5$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

AUC_j_fac_dense<-vector()
for(i in 1:data$J) AUC_j_fac_dense<-c(AUC_j_fac_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))
  

```




### Gjam




```{r gjam fd5,include=TRUE,echo=FALSE}
data<-sim_data$FacDenseSp5
#gjam_mod<-fit_gjam(data,10000,2000,"./gjam_models/gjam5f.rda",interact=fac_inter[[4]])
gjam_mod<-load_gjam(data,10000,2000,name="./gjam_models/gjam5f.rda", interact=fac_inter[[4]])
g_metric_facDense5<-metrics_gjam(gjam_mod$Rho_sign,fac=fac_inter[[4]], only_env = F)
g_metric_facDense5_p<-metrics_gjam(gjam_mod$Tau_sign,fac=fac_inter[[4]], only_env = F)
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_facDense5$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_facDense5$success_fac,3)))
#Correlation
mod_list_Rho<-list.append(mod_list_Rho,gjam=gjam_mod$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,gjam=gjam_mod$Tau_sign)
#Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

AUC_g_fac_dense<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_fac_dense<-c(AUC_g_fac_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))


pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

```





### HMSC






```{r hmsc fd5, include=TRUE, echo=FALSE}
data<-sim_data$FacDenseSp5
hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm5fd.rda" )
hm_conv(hm_mod)
hm_inter(hm_mod, interact = fac_inter[[4]])
hm_mod_R<-hm_inter(hm_mod)

h_metric_facDense5<-metrics_hmsc(hm_mod_R$Rho_sign,fac=fac_inter[[4]],only_env = F)
h_metric_facDense5_p<-metrics_hmsc(hm_mod_R$Tau_sign,fac=fac_inter[[4]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_facDense5$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_facDense5$success_fac,3)))

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}
pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

AUC_h_fac_dense<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_fac_dense<-c(AUC_h_fac_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))


```





### Dimension reduction gjam




```{r dimred facd5, include=TRUE,echo=FALSE}

S<- gjam_dim_red_5(sim_data$FacDenseSp5,ng=10000, burnin=1000, name="./gjam_models/gjamDR5facd.rda", regime="L")
g_dr_metric_facDense5<-metrics_gjam(S$Rho_sign_d,fac=fac_inter[[4]], only_env = F)
g_dr_metric_facDense5_p<-metrics_gjam(S$Tau_sign_d,fac=fac_inter[[4]], only_env = F)


AUC_gdr_fac_dense<-vector()
##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacDenseSp5
for(i in 1:(ncol(data)-1)) AUC_gdr_fac_dense<-c(AUC_gdr_fac_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)


par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200), cl.lim=c(0, 1),type = "lower")
title("Posterior clusters from dim. reduction")
corrplot(fac_inter[[4]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```



###Summary plots




```{r all models facd5, include=TRUE,warning=FALSE,message=FALSE}
sdm_envfcd5<-predict_sdm(sim_data$FacDenseSp5)


create_beta_plot(load_object("./gjam_models/gjam5f.rda"),mfd5,load_object("./new_HMmodels/hm5fd.rda" ),S$bchain,sdm_envfcd5$beta_sdm)

create_plot_response(sim_data$FacDenseSp5, nsp=5,pred_gjam, pred_jsdm,pred_hmsc, pred_gjam_dr,sdm_envfcd5$pred_sdm)


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,fac_inter[[4]])

```




```{r all models tau facd5, include=TRUE}

ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,diag(10))

```






## Environmental filtering + Facilitation dense 10 species






### JSDM

```{r model jsdm facdd10, echo=FALSE,include=FALSE}
#load("model-2019-04-10-15-13-15.rda")
mfd10 <- load_object("model-2019-04-12-06-59-42.rda")

summary(mfd10)
jsdm_conv(mfd10)
mfd10$mcmc.info[1:7]

j_metric_facDense10<-metrics_jsdm((!mfd10$overlap0$Rho)*mfd10$mean$Rho,fac = fac_inter[[5]],only_env = F)
j_metric_facDense10_p<-metrics_jsdm(jsdm_tau(mfd10)$Tau_sign,fac = fac_inter[[5]],only_env = F)
######################################################Prepare data
data<-sim_data$FacDenseSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

######################################################Plot 

#plot_cor_jsdm(mfd10,data$Y,fac_inter[[5]])
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mfd10$mean$Rho*(!mfd10$overlap0$Rho))  

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mfd10)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,mfd10$mcmc.info$n.samples))
for(i in 1:mfd10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mfd10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_fac_dense<-c(AUC_j_fac_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```



### Gjam



```{r gjam fd10,include=TRUE,echo=FALSE}
data<-sim_data$FacDenseSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam10fd.rda",interact=fac_inter[[5]])
gjam_mod<- load_gjam(data,10000,1000,name="./gjam_models/gjam10fd.rda", interact=fac_inter[[5]])
g_metric_facDense10<-metrics_gjam(gjam_mod$Rho_sign,fac=fac_inter[[5]], only_env = F)
g_metric_facDense10_p<-metrics_gjam(gjam_mod$Tau_sign,fac=fac_inter[[5]], only_env = F)
#######################################
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_facDense10$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_facDense10$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho,gjam=gjam_mod$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,gjam=gjam_mod$Tau_sign)

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

for(i in 1:(ncol(data)-1)) AUC_g_fac_dense<-c(AUC_g_fac_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)



```




### HMSC



```{r model2 hmsc,  include=TRUE, echo=FALSE}
data<-sim_data$FacDenseSp10
hm_mod<-fit_hmsc(data,"Load",nsamples = 2000,nchains=2,name="./new_HMmodels/hm10fd.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples = 2000,nchains=2,interact = fac_inter[[5]])

h_metric_facDense10<-metrics_hmsc(hm_mod_R$Rho_sign,fac=fac_inter[[5]],only_env = F)
h_metric_facDense10_p<-metrics_hmsc(hm_mod_R$Tau_sign,fac=fac_inter[[5]],only_env = F)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_fac_dense<-c(AUC_h_fac_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```


### Dimension reduction



```{r dim red  facd10, include=TRUE, echo=FALSE}

#r-opt=7
#try r=3
S<- gjam_dim_red(sim_data$FacDenseSp10,ng=10000, burnin=1000,r=3, name="./gjam_models/gjamDR10facd.rda", regime="L")
pg<- comp.psm(S$k)
g_dr_metric_facDense10<-metrics_gjam(S$Rho_sign_d,fac=fac_inter[[5]], only_env = F)
g_dr_metric_facDense10_p<-metrics_gjam(S$Tau_sign_d,fac=fac_inter[[5]], only_env = F)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacDenseSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_fac_dense<-c(AUC_gdr_fac_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)


par(mfrow=c(2,2))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(pg, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(300),cl.lim=c(0, 1), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot(fac_inter[[5]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




###Summary plots


```{r all models facd10, include=TRUE,warning=FALSE,message=FALSE}
sdm_envfcd10<-predict_sdm(sim_data$FacDenseSp10)

create_beta_plot(load_object("./gjam_models/gjam10fd.rda"),mfd10,load_object("./new_HMmodels/hm10fd.rda"),S$bchain,sdm_envfcd10$beta_sdm)

create_plot_response(sim_data$FacDenseSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envfcd10$pred_sdm)


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,fac_inter[[5]])

```


```{r all models tau facd10, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,fac_inter[[5]])

```






## Environmental filtering + Facilitation dense 20 species





### JSDM

```{r model jsdm fd20, echo=FALSE,include=FALSE}
#load("model-2019-04-10-15-13-15.rda")
mfd20 <- load_object("model-2019-04-13-17-22-12.rda")

summary(mfd20)
#mfd20$Rhat
jsdm_conv(mfd20)
mfd20$mcmc.info[1:7]

j_metric_facDense20<-metrics_jsdm((!mfd20$overlap0$Rho)*mfd20$mean$Rho,fac = fac_inter[[6]],only_env = F)
j_metric_facDense20_p<-metrics_jsdm(jsdm_tau(mfd20)$Tau_sign,fac = fac_inter[[6]],only_env = F)

######################################################Prepare data
data<-sim_data$FacDenseSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mfd20$mean$Rho*(!mfd20$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mfd20)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,mfd20$mcmc.info$n.samples))
for(i in 1:mfd20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mfd20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_fac_dense<-c(AUC_j_fac_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```


### Gjam


```{r gjam fd20,include=TRUE,echo=FALSE}
data<-sim_data$FacDenseSp20
#gjam_mod<-fit_gjam(data,10000,1500,"./gjam_models/gjam20fd.rda",interact=fac_inter[[6]])
gjam_mod<-load_gjam(data,10000,1500,name="./gjam_models/gjam20fd.rda", interact=fac_inter[[6]])
g_metric_facDense20<-metrics_gjam(gjam_mod$Rho_sign,fac=fac_inter[[6]], only_env = F)
g_metric_facDense20_p<-metrics_gjam(gjam_mod$Tau_sign,fac=fac_inter[[6]], only_env = F)
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

for(i in 1:(ncol(data)-1)) AUC_g_fac_dense<-c(AUC_g_fac_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)
```


### HMSC


```{r hmsc fd20,echo=FALSE,include=TRUE}
data<-sim_data$FacDenseSp20
hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm20fd.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, interact = fac_inter[[6]])

h_metric_facDense20<-metrics_hmsc(hm_mod_R$Rho_sign,fac=fac_inter[[6]],only_env = F)
h_metric_facDense20_p<-metrics_hmsc(hm_mod_R$Tau_sign,fac=fac_inter[[6]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_facDense20$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_facDense20$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}
pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_fac_dense<-c(AUC_h_fac_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```


```{r dim red  facd20, include=TRUE, echo=FALSE}

#r-opt=15
S<- gjam_dim_red(sim_data$FacDenseSp20,ng=10000, burnin=1000,r=3, name="./gjam_models/gjamDR20facd.rda", regime="L")
g_dr_metric_facDense20<-metrics_gjam(S$Rho_sign_d,fac=fac_inter[[6]], only_env = F)
g_dr_metric_facDense20_p<-metrics_gjam(S$Tau_sign_d,fac=fac_inter[[6]], only_env = F)
##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacDenseSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_fac_dense<-c(AUC_gdr_fac_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)


par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(diag(20), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```

```{r all models facd20, include=TRUE,message=FALSE,warning=FALSE}
sdm_envfcd20<-predict_sdm(sim_data$FacDenseSp20)


create_beta_plot(load_object("./gjam_models/gjam20fd.rda"),mfd20,load_object("./new_HMmodels/hm20fd.rda"),S$bchain,sdm_envfcd20$beta_sdm)

create_plot_response(sim_data$FacDenseSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc ,pred_gjam_dr,sdm_envfcd20$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,fac_inter[[6]])

```


```{r all models tau facd20, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,fac_inter[[6]])

```







## Environmental filtering + Facilitation sparse 5 species









### JSDM


```{r model jsdm fs5, echo=FALSE,include=TRUE}
#load("model-2019-04-10-15-13-15.rda")
mfs5 <- load_object("model-2019-04-13-17-51-16.rda")

summary(mfs5)
#mfs5$Rhat
jsdm_conv(mfs5)

mfs5$mcmc.info[1:7]

j_metric_facSparse5<-metrics_jsdm((!mfs5$overlap0$Rho)*mfs5$mean$Rho,fac = fac_inter[[7]],only_env = F)
j_metric_facSparse5_p<-metrics_jsdm(jsdm_tau(mfs5)$Tau_sign,fac = fac_inter[[7]],only_env = F)


######################################################Prepare data
data<-sim_data$FacSparseSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mfs5$mean$Rho*(!mfs5$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mfs5)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,mfs5$mcmc.info$n.samples))
for(i in 1:mfs5$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mfs5$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

AUC_j_fac_sparse<-vector()
for(i in 1:data$J) AUC_j_fac_sparse<-c(AUC_j_fac_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```


### Gjam

```{r gjam fs5,include=TRUE,echo=FALSE}

data<-sim_data$FacSparseSp5
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam5fs.rda",interact=fac_inter[[7]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam5fs.rda", interact=fac_inter[[7]])

g_metric_facSparse5<-metrics_gjam(gjam_mod$Rho_sign,fac=fac_inter[[7]], only_env = F)
g_metric_facSparse5_p<-metrics_gjam(gjam_mod$Tau_sign,fac=fac_inter[[7]], only_env = F)
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_facSparse5$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_facSparse5$success_fac,3)))
##Correlation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
##Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)
##AUC
AUC_g_fac_sparse<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_fac_sparse<-c(AUC_g_fac_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)
```

### HMSC
```{r hmsc fs5,echo=FALSE, include=TRUE}
data<-sim_data$FacSparseSp5
hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm5fs.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, interact = fac_inter[[7]])
h_metric_facSparse5<-metrics_hmsc(hm_mod_R$Rho_sign,fac=fac_inter[[8]],only_env = F)
h_metric_facSparse5_p<-metrics_hmsc(hm_mod_R$Tau_sign,fac=fac_inter[[8]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_facSparse5$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_facSparse5$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

#Prediction
pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

AUC_h_fac_sparse<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_fac_sparse<-c(AUC_h_fac_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```




### Dimension reduction gjam





```{r dimred fs5, include=TRUE,echo=FALSE}
S<- gjam_dim_red_5(sim_data$FacSparseSp5,ng=10000, burnin=1000, name="./gjam_models/gjamDR5facs.rda", regime="L")
g_dr_metric_facSparse5<-metrics_gjam(S$Rho_sign_d,fac=fac_inter[[7]], only_env = F)
g_dr_metric_facSparse5_p<-metrics_gjam(S$Tau_sign_d,fac=fac_inter[[7]], only_env = F)


AUC_gdr_fac_sparse<-vector()

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacSparseSp5
for(i in 1:(ncol(data)-1)) AUC_gdr_fac_sparse<-c(AUC_gdr_fac_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)

par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot(fac_inter[[8]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```




```{r all models fs5, include=TRUE,message=FALSE, warning=FALSE}
sdm_envfcs5<-predict_sdm(sim_data$FacSparseSp5)

create_beta_plot(load_object("./gjam_models/gjam5fs.rda"),mfs5,load_object("./new_HMmodels/hm5fs.rda"),S$bchain,sdm_envfcs5$beta_sdm)

create_plot_response(sim_data$FacSparseSp5, nsp=5,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envfcs5$pred_sdm )

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,fac_inter[[7]])

```


```{r all models tau fs5, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,fac_inter[[7]])

```







## Environmental filtering + Facilitation sparse 10 species







### JSDM



```{r model jsdm fs10, echo=FALSE,include=FALSE}
mfs10 <- load_object("model-2019-04-14-05-17-58.rda")

summary(mfs10)
#mfs10$Rhat
jsdm_conv(mfs10)
mfs10$mcmc.info[1:7]

j_metric_facSparse10<-metrics_jsdm((!mfs10$overlap0$Rho)*mfs10$mean$Rho,fac = fac_inter[[8]],only_env = F)
j_metric_facSparse10_p<-metrics_jsdm(jsdm_tau(mfs10)$Tau_sign,fac = fac_inter[[8]],only_env = F)

######################################################Prepare data
data<-sim_data$FacSparseSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)


mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mfs10$mean$Rho*(!mfs10$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mfs10)$Tau_sign) 
 
pred_j<-array(NA,dim=c(data$n,data$J,mfs10$mcmc.info$n.samples))
for(i in 1:mfs10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mfs10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_fac_sparse<-c(AUC_j_fac_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))
```




###GJAM





```{r gjam fs10,include=TRUE,echo=FALSE}
data<-sim_data$FacSparseSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam10fs.rda",interact=fac_inter[[8]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam10fs.rda", interact=fac_inter[[8]])
g_metric_facSparse10<-metrics_gjam(gjam_mod$Rho_sign,fac=fac_inter[[8]], only_env = F)
g_metric_facSparse10_p<-metrics_gjam(gjam_mod$Tau_sign,fac=fac_inter[[8]], only_env = F)

mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
##Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

for(i in 1:(ncol(data)-1)) AUC_g_fac_sparse<-c(AUC_g_fac_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)
```





### HMSC





```{r hmsc fs10,echo=FALSE, include=TRUE}
data<-sim_data$FacSparseSp10

hm_mod<-fit_hmsc(data,"Load",name="./new_HMmodels/hm10fs.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, interact = fac_inter[[8]])
h_metric_facSparse10<-metrics_hmsc(hm_mod_R$Rho_sign,fac=fac_inter[[8]],only_env = F)
h_metric_facSparse10_p<-metrics_hmsc(hm_mod_R$Tau_sign,fac=fac_inter[[8]],only_env = F)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}
###Prediction
pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_fac_sparse<-c(AUC_h_fac_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```



### Dimension reduction gjam



```{r dim red  facs10, include=TRUE, echo=FALSE}
#r-opt=5
S<- gjam_dim_red(sim_data$FacSparseSp10,ng=10000, burnin=1000,r=5, name="./gjam_models/gjamDR10facs.rda", regime="L")
g_dr_metric_facSparse10<-metrics_gjam(S$Rho_sign_d,fac=fac_inter[[8]], only_env = F)
g_dr_metric_facSparse10_p<-metrics_gjam(S$Tau_sign_d,fac=fac_inter[[8]], only_env = F)

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacSparseSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_fac_sparse<-c(AUC_gdr_fac_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)


par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(fac_inter[[8]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```



###Summary plots





```{r all models fs10, include=TRUE,message=FALSE, warning=FALSE}
sdm_envfcs10<-predict_sdm(sim_data$FacSparseSp10)

create_beta_plot(load_object("./gjam_models/gjam10fs.rda"),mfs10,load_object("./new_HMmodels/hm10fs.rda"),S$bchain,sdm_envfcs10$beta_sdm)

create_plot_response(sim_data$FacSparseSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envfcs10$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,fac_inter[[8]])
```



```{r all models tau fs10, include=TRUE}


ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,fac_inter[[8]])


```






## Environmental filtering + Facilitation sparse 20 species







### JSDM







```{r model jsdm fs20, echo=FALSE,include=FALSE}
#load("model-2019-04-10-15-13-15.rda")
mfs20 <- load_object("model-2019-04-15-15-34-20.rda")
summary(mfs20)
#mfs20$Rhat
jsdm_conv(mfs20)
mfs20$mcmc.info[1:7]
j_metric_facSparse20<-metrics_jsdm((!mfs20$overlap0$Rho)*mfs20$mean$Rho,fac = fac_inter[[9]],only_env = F)
j_metric_facSparse20_p<-metrics_jsdm(jsdm_tau(mfs20)$Tau_sign,fac = fac_inter[[9]],only_env = F)
######################################################Prepare data
data<-sim_data$FacSparseSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mfs20$mean$Rho*(!mfs20$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mfs20)$Tau_sign) 
 
pred_j<-array(NA,dim=c(data$n,data$J,mfs20$mcmc.info$n.samples))
for(i in 1:mfs20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mfs20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_fac_sparse<-c(AUC_j_fac_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```






### Gjam





```{r gjam fs20,include=TRUE,echo=FALSE}
data<-sim_data$FacSparseSp20

#gjam_mod<- fit_gjam(data,10000,1500,"./gjam_models/gjam20fs.rda",interact=fac_inter[[9]])
gjam_mod <-load_gjam(data,10000,1500,name="./gjam_models/gjam20fs.rda", interact=fac_inter[[9]])

g_metric_facSparse20<-metrics_gjam(gjam_mod$Rho_sign,fac=fac_inter[[9]], only_env = F)
g_metric_facSparse20_p<-metrics_gjam(gjam_mod$Tau_sign,fac=fac_inter[[9]], only_env = F)

##Correlation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
#Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_fac_sparse<-c(AUC_g_fac_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))


```






### HMSC





```{r hmsc fs20,echo=FALSE, include=TRUE}
data<-sim_data$FacSparseSp20
hm_mod<-fit_hmsc(data,nsamples=3000, nchains=2,"Load",name="./new_HMmodels/hm20fs.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=3000, nchains=2,interact = fac_inter[[9]])
h_metric_facSparse20<-metrics_hmsc(hm_mod_R$Rho_sign,fac=fac_inter[[9]],only_env = F)
h_metric_facSparse20_p<-metrics_hmsc(hm_mod_R$Tau_sign,fac=fac_inter[[9]],only_env = F)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_fac_sparse<-c(AUC_h_fac_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```



### Dimension reduction



```{r dim red  facs20, include=TRUE, echo=FALSE}

#r-opt=15
S<- gjam_dim_red(sim_data$FacSparseSp20,ng=10000, burnin=1000,r=10, name="./gjam_models/gjamDR20facs.rda", regime="L")
g_dr_metric_facSparse20<-metrics_gjam(S$Rho_sign_d,fac=fac_inter[[9]], only_env = F)
g_dr_metric_facSparse20_p<-metrics_gjam(S$Tau_sign_d,fac=fac_inter[[9]], only_env = F)

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacSparseSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_fac_sparse<-c(AUC_gdr_fac_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)

par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(fac_inter[[9]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```





### Summary plots




```{r all models fs20, include=TRUE,message=FALSE,warning=FALSE}

sdm_envfcs20<-predict_sdm(sim_data$FacSparseSp20)

create_beta_plot(load_object("./gjam_models/gjam20fs.rda"),mfs20,load_object("./new_HMmodels/hm20fs.rda"),S$bchain,sdm_envfcs20$beta_sdm)
create_plot_response(sim_data$FacSparseSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc , pred_gjam_dr,sdm_envfcs20$pred_sdm)
ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,fac_inter[[9]])

```




```{r all models tau fs20, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,fac_inter[[9]])
```






## Environmental filtering + Competition dense 5 species






### JSDM




```{r model jsdm cmpd5, echo=FALSE,include=FALSE}
#load("model-2019-04-10-15-13-15.rda")
mcmpd5 <- load_object("model-2019-04-15-16-03-39.rda")

summary(mcmpd5)
#mcmpd5$Rhat
jsdm_conv(mcmpd5)

mcmpd5$mcmc.info[1:7]

j_metric_compDense5<-metrics_jsdm((!mcmpd5$overlap0$Rho)*mcmpd5$mean$Rho,comp = comp_inter[[10]],only_env = F)
j_metric_compDense5_p<-metrics_jsdm(jsdm_tau(mcmpd5)$Tau_sign,comp = comp_inter[[10]],only_env = F)

######################################################Prepare data
data<-sim_data$CompDenseSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
####Correlation
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mcmpd5$mean$Rho*(!mcmpd5$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mcmpd5)$Tau_sign) 
###Prediction 
pred_j<-array(NA,dim=c(data$n,data$J,mcmpd5$mcmc.info$n.samples))
for(i in 1:mcmpd5$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mcmpd5$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

AUC_j_comp_dense<-vector()
for(i in 1:data$J) AUC_j_comp_dense<-c(AUC_j_comp_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```





### Gjam




```{r gjam cmpd5,include=TRUE,echo=FALSE}
data<-sim_data$CompDenseSp5
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam5cmpd.rda",interact=comp_inter[[10]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam5cmpd.rda", interact=(-1)*comp_inter[[10]])
g_metric_compDense5<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[10]], only_env = F)
g_metric_compDense5_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[10]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_compDense5$success_env,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_compDense5$success_comp,3)))
###Correlation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
#Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)
pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

AUC_g_comp_dense<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_comp_dense<-c(AUC_g_comp_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```



### HMSC



```{r hmsc cmpd5,echo=FALSE, include=TRUE}
data<-sim_data$CompDenseSp5

hm_mod<-fit_hmsc(data,"Load",nsamples=3000, nchains=2,name="./new_HMmodels/hm5cmpd.rda" )
#hm_mod<-fit_hmsc(data,"Fit",nsamples=3000, nchains=2 )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=3000, nchains=2,interact = (-1)*comp_inter[[10]])

h_metric_compDense5<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[10]],only_env = F)
h_metric_compDense5_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[10]],only_env = F)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

AUC_h_comp_dense<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_comp_dense<-c(AUC_h_comp_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```




### Dimension reduction



```{r dimred compd5, include=TRUE,echo=FALSE}

S<- gjam_dim_red_5(sim_data$CompDenseSp5,ng=10000, burnin=1000, name="./gjam_models/gjamDR5compd.rda", regime="L")
g_dr_metric_compDense5<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[10]], only_env = F)
g_dr_metric_compDense5_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[10]], only_env = F)

AUC_gdr_comp_dense<-vector()

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$CompDenseSp5
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_dense<-c(AUC_gdr_comp_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)

par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot(comp_inter[[10]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```



###Summary plots



```{r all models cmpd5, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmpd5<-predict_sdm(sim_data$CompDenseSp5)

create_beta_plot(load_object("./gjam_models/gjam5cmpd.rda"),mcmpd5,load_object("./new_HMmodels/hm5cmpd.rda"),S$bchain,sdm_envcmpd5$beta_sdm)
create_plot_response(sim_data$CompDenseSp5, nsp=5,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envcmpd5$pred_sdm )
ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,(-1)*comp_inter[[10]])

```







```{r all models tau fcmpd5, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,(-1)*comp_inter[[10]])
```






## Environmental filtering + Competition dense 10 species




###JSDM




```{r model jsdm cmpd10, echo=FALSE,include=FALSE}
#load("model-2019-04-10-15-13-15.rda")
mcmpd10 <- load_object("model-2019-04-16-03-39-17.rda")

summary(mcmpd10)
#mcmpd10$Rhat

jsdm_conv(mcmpd10)
mcmpd10$mcmc.info[1:7]

j_metric_compDense10<-metrics_jsdm((!mcmpd10$overlap0$Rho)*mcmpd10$mean$Rho,comp = comp_inter[[11]],only_env = F)
j_metric_compDense10_p<-metrics_jsdm(jsdm_tau(mcmpd10)$Tau_sign,comp = comp_inter[[11]],only_env = F)

######################################################Prepare data
data<-sim_data$CompDenseSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
##Correlation
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mcmpd10$mean$Rho*(!mcmpd10$overlap0$Rho))  

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mcmpd10)$Tau_sign)  
 ##Prediction
pred_j<-array(NA,dim=c(data$n,data$J,mcmpd10$mcmc.info$n.samples))
for(i in 1:mcmpd10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mcmpd10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_dense<-c(AUC_j_comp_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```







### Gjam






```{r gjam cmpd10,include=TRUE,echo=FALSE}
data<-sim_data$CompDenseSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam10cmpd.rda",interact=comp_inter[[11]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam10cmpd.rda", interact= (-1)*comp_inter[[11]])
g_metric_compDense10<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[11]], only_env = F)
g_metric_compDense10_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[11]], only_env = F)

###Correlation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
#Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_dense<-c(AUC_g_comp_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```








### HMSC






```{r hmsc cmpd10,echo=FALSE, include=TRUE}
data<-sim_data$CompDenseSp10
hm_mod<-fit_hmsc(data,"Load",nsamples=5000, nchains=2,name="./new_HMmodels/hm10cmpd.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod,nsamples=5000, nchains=2, interact =  (-1)*comp_inter[[11]])

h_metric_compDense10<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[11]],only_env = F)
h_metric_compDense10_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[11]],only_env = F)
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_compDense10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_compDense10$success_comp,3)))
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_dense<-c(AUC_h_comp_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```







### Dimension reduction





```{r dim red compd10,include=TRUE, echo=FALSE}

#r-opt=5
S<- gjam_dim_red(sim_data$CompDenseSp10,ng=10000, burnin=1000,r=5, name="./gjam_models/gjamDR10compd.rda", regime="L")
g_dr_metric_compDense10<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[11]], only_env = F)
g_dr_metric_compDense10_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[11]], only_env = F)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$CompDenseSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_dense<-c(AUC_gdr_comp_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)


par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp_inter[[11]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```


###Summary plots 



```{r all models cmpd10, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmpd10<-predict_sdm(sim_data$CompDenseSp10)

create_beta_plot(load_object("./gjam_models/gjam10cmpd.rda"),mcmpd10,load_object("./new_HMmodels/hm10cmpd.rda"),S$bchain,sdm_envcmpd10$beta_sdm)

create_plot_response(sim_data$CompDenseSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envcmpd10$pred_sdm)


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,(-1)*comp_inter[[11]])

```


```{r all models tau cmpd10, include=TRUE}

ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,(-1)*comp_inter[[11]])

```





## Environmental filtering + Competition dense 20 species



### JSDM


```{r model jsdm cmpd20, echo=FALSE,include=FALSE}
#load("model-2019-04-10-15-13-15.rda")
mcmpd20 <- load_object("model-2019-04-17-14-00-45.rda")

summary(mcmpd20)
#mcmpd10$Rhat

jsdm_conv(mcmpd20)
mcmpd20$mcmc.info[1:7]

j_metric_compDense20<-metrics_jsdm((!mcmpd20$overlap0$Rho)*mcmpd20$mean$Rho,comp = comp_inter[[12]],only_env = F)
j_metric_compDense20_p<-metrics_jsdm(jsdm_tau(mcmpd20)$Tau_sign,comp = comp_inter[[12]],only_env = F)

######################################################Prepare data
data<-sim_data$CompDenseSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
#Tau_n<-to_prec(mfd10$mean$Tau)
#plot_cor_jsdm(mcmpd20,data$Y, (-1)*comp_inter[[12]])



mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =mcmpd20$mean$Rho*(!mcmpd20$overlap0$Rho))  

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(mcmpd20)$Tau_sign) 
 
pred_j<-array(NA,dim=c(data$n,data$J,mcmpd20$mcmc.info$n.samples))
for(i in 1:mcmpd20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(mcmpd20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_dense<-c(AUC_j_comp_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```



### Gjam





```{r gjam cmpd20,include=TRUE,echo=FALSE}
data<-sim_data$CompDenseSp20
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam20cmpd.rda",interact= (-1)*comp_inter[[12]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam20cmpd.rda", interact= (-1)*comp_inter[[12]])
g_metric_compDense20<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[12]], only_env = F)
g_metric_compDense20_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[12]], only_env = F)
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_compDense20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_compDense20$success_comp,3)))
#Correlation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
#Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_dense<-c(AUC_g_comp_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```






### HMSC





```{r hmsc cmpd20,echo=FALSE, include=TRUE}
data<-sim_data$CompDenseSp20
hm_mod<-fit_hmsc(data,"Load",nsamples=5000, nchains=2,name="./new_HMmodels/hm20cmpd.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=5000, nchains=2,interact =(-1)*comp_inter[[12]])

h_metric_compDense20<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[12]],only_env = F)
h_metric_compDense20_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[12]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_compDense20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_compDense20$success_comp,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_dense<-c(AUC_h_comp_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```




### Dimension reduction




```{r dim red compd20, include=TRUE, echo=FALSE}

#r-opt=15
S<- gjam_dim_red(sim_data$CompDenseSp20,ng=10000, burnin=1000,r=3, name="./gjam_models/gjamDR20compd.rda", regime="L")
g_dr_metric_compDense20<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[12]], only_env = F)
g_dr_metric_compDense20_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[12]], only_env = F)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$CompDenseSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_dense<-c(AUC_gdr_comp_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)

par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp_inter[[12]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




### Summary plots





```{r all models cmpd20, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmpd20<-predict_sdm(sim_data$CompDenseSp20)

create_beta_plot(load_object("./gjam_models/gjam20cmpd.rda"),mcmpd20,load_object("./new_HMmodels/hm20cmpd.rda" ),S$bchain,sdm_envcmpd20$beta_sdm)

create_plot_response(sim_data$CompDenseSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc,  pred_gjam_dr,sdm_envcmpd20$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,(-1)*comp_inter[[12]])

```








```{r all models tau cmpd20, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,(-1)*comp_inter[[12]])
```






## Environmental filtering + Competition sparse 5 species







### JSDM

```{r model jsdm cmps5, echo=FALSE,include=FALSE}
#load("model-2019-04-17-14-30-01.rda")
cmps5 <- load_object("model-2019-04-17-14-30-01.rda")

summary(cmps5)
jsdm_conv(cmps5)
cmps5$mcmc.info[1:7]
j_metric_compSparse5<-metrics_jsdm((!cmps5$overlap0$Rho)*cmps5$mean$Rho,comp = comp_inter[[13]],only_env = F)
j_metric_compSparse5_p<-metrics_jsdm(jsdm_tau(cmps5)$Tau_sign,comp = comp_inter[[13]],only_env = F)



######################################################Prepare data
data<-sim_data$CompSparseSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmps5$mean$Rho*(!cmps5$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmps5)$Tau_sign) 
####Prediction  
pred_j<-array(NA,dim=c(data$n,data$J,cmps5$mcmc.info$n.samples))
for(i in 1:cmps5$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmps5$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

AUC_j_comp_sparse<-vector()
for(i in 1:data$J) AUC_j_comp_sparse<-c(AUC_j_comp_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```




### Gjam

```{r gjam cmps5,include=TRUE,echo=FALSE}
data<-sim_data$CompSparseSp5
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam5cmps.rda",interact= (-1)*comp_inter[[13]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam5cmps.rda", interact= (-1)*comp_inter[[13]])

g_metric_compSparse5<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[13]], only_env = F)
g_metric_compSparse5_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[13]], only_env = F)
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_compSparse5$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_compSparse5$success_comp,3)))
#Corrleation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
###Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

AUC_g_comp_sparse<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_comp_sparse<-c(AUC_g_comp_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```






### HMSC





```{r hmsc cmps5,echo=FALSE, include=TRUE}
data<-sim_data$CompSparseSp5

hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hm5cmps.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[13]])

h_metric_compSparse5<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[13]],only_env = F)
h_metric_compSparse5_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[13]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_compSparse5$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_compSparse5$success_comp,3)))

#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

AUC_h_comp_sparse<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_comp_sparse<-c(AUC_h_comp_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```




### Dimension reduction




```{r dimred comps5, include=TRUE,echo=FALSE}

S<- gjam_dim_red_5(sim_data$CompSparseSp5,ng=10000, burnin=1000, name="./gjam_models/gjamDR5comps.rda", regime="L")
g_dr_metric_compSparse5<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[13]], only_env = F)
g_dr_metric_compSparse5_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[13]], only_env = F)


AUC_gdr_comp_sparse<-vector()
##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$CompSparseSp5
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_sparse<-c(AUC_gdr_comp_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)



par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot(comp_inter[[13]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```






### Summary plots




```{r all models cmps5, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmps5<-predict_sdm(sim_data$CompSparseSp5)

create_beta_plot(load_object("./gjam_models/gjam5cmps.rda"),cmps5,load_object("./new_HMmodels/hm5cmps.rda"),S$bchain,sdm_envcmps5$beta_sdm)

create_plot_response(sim_data$CompSparseSp5, nsp=5,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envcmps5$pred_sdm)
ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,(-1)*comp_inter[[13]])

```


```{r all models tau cmps5, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,(-1)*comp_inter[[13]])

```







## Environmental filtering + Competition sparse 10 species




### JSDM


```{r model jsdm cmps10, echo=FALSE,include=FALSE}
#load("model-2019-04-17-14-30-01.rda")
cmps10 <- load_object("model-2019-04-18-01-55-45.rda")

summary(cmps10)
jsdm_conv(cmps10)
cmps10$mcmc.info[1:7]

j_metric_compSparse10<-metrics_jsdm((!cmps10$overlap0$Rho)*cmps10$mean$Rho,comp = comp_inter[[14]],only_env = F)
j_metric_compSparse10_p<-metrics_jsdm(jsdm_tau(cmps10)$Tau_sign,comp = comp_inter[[14]],only_env = F)


######################################################Prepare data
data<-sim_data$CompSparseSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmps10$mean$Rho*(!cmps10$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmps10)$Tau_sign) 
###Prediction  
pred_j<-array(NA,dim=c(data$n,data$J,cmps10$mcmc.info$n.samples))
for(i in 1:cmps10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmps10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_sparse<-c(AUC_j_comp_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```




### Gjam



```{r gjam cmps10,include=TRUE,echo=FALSE}
data<-sim_data$CompSparseSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam10cmps.rda",interact= (-1)*comp_inter[[14]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam10cmps.rda", interact= (-1)*comp_inter[[14]])

g_metric_compSparse10<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[14]], only_env = F)
g_metric_compSparse10_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[14]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_compSparse10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_compSparse10$success_comp,3)))
###Coorrelation
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
###Prediction

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_sparse<-c(AUC_g_comp_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

```


### HMSC


```{r hmsc cmps10,  echo=FALSE, include=TRUE}
data<-sim_data$CompSparseSp10
hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hm10cmps.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[14]])

h_metric_compSparse10<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[14]],only_env = F)
h_metric_compSparse10_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[14]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_compSparse10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_compSparse10$success_comp,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_sparse<-c(AUC_h_comp_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```


### Dimension reduction

```{r dim red comps10, include=TRUE, echo=FALSE}

#r-opt=5
S<- gjam_dim_red(sim_data$CompSparseSp10,ng=10000, burnin=1000,r=3,name="./gjam_models/gjamDR10comps.rda", regime="L")
g_dr_metric_compSparse10<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[14]], only_env = F)
g_dr_metric_compSparse10_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[14]], only_env = F)

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$CompSparseSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_sparse<-c(AUC_gdr_comp_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)




par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp_inter[[14]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




### Summary plots




```{r all models cmps10, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmps10<-predict_sdm(sim_data$CompSparseSp10)

create_beta_plot(load_object("./gjam_models/gjam10cmps.rda"),cmps10,load_object("./new_HMmodels/hm10cmps.rda"),S$bchain,sdm_envcmps10$beta_sdm)

create_plot_response(sim_data$CompSparseSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc ,pred_gjam_dr,sdm_envcmps10$pred_sdm)
ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,(-1)*comp_inter[[14]])

```



```{r all models tau cmps10, include=TRUE}


ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,(-1)*comp_inter[[14]])

```







## Environmental filtering + Competition sparse 20 species








### JSDM 

```{r model jsdm cmps20, echo=FALSE,include=FALSE}
#load("model-2019-04-17-14-30-01.rda")
cmps20 <- load_object("model-2019-04-19-12-40-30.rda")

summary(cmps20)
jsdm_conv(cmps20)
cmps20$mcmc.info[1:7]


j_metric_compSparse20<-metrics_jsdm((!cmps20$overlap0$Rho)*cmps20$mean$Rho,comp = comp_inter[[15]],only_env = F)
j_metric_compSparse20_p<-metrics_jsdm(jsdm_tau(cmps20)$Tau_sign,comp = comp_inter[[15]],only_env = F)


######################################################Prepare data
data<-sim_data$CompSparseSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmps20$mean$Rho*(!cmps20$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmps20)$Tau_sign)  
  
pred_j<-array(NA,dim=c(data$n,data$J,cmps20$mcmc.info$n.samples))
for(i in 1:cmps20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmps20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_sparse<-c(AUC_j_comp_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```



### Gjam




```{r gjam cmps20,include=TRUE,echo=FALSE}
data<-sim_data$CompSparseSp20
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjam20cmps.rda",interact= (-1)*comp_inter[[15]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjam20cmps.rda", interact= (-1)*comp_inter[[15]])

g_metric_compSparse20<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[15]], only_env = F)
g_metric_compSparse20_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[15]], only_env = F)
cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_compSparse20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_compSparse20$success_comp,3)))

mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 
###Prediction
pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_sparse<-c(AUC_g_comp_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```





### HMSC




```{r hmsc cmps20,echo=FALSE, include=TRUE}
data<-sim_data$CompSparseSp20

hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hm20cmps.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[15]])

h_metric_compSparse20<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[15]],only_env = F)
h_metric_compSparse20_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[15]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_compSparse20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_compSparse20$success_comp,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)

mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_sparse<-c(AUC_h_comp_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```




### Dimension reduction





```{r dim red comps20, include=TRUE, echo=FALSE}

#r-opt=13
S<- gjam_dim_red(sim_data$CompSparseSp20,ng=10000, burnin=1000,r=13,name="./gjam_models/gjamDR20comps.rda", regime="L")
g_dr_metric_compSparse20<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[15]], only_env = F)
g_dr_metric_compSparse20_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[15]], only_env = F)

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$CompSparseSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_sparse<-c(AUC_gdr_comp_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)



par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp_inter[[15]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




### Summary plots



```{r all models cmps20, include=TRUE,warning=FALSE,message=FALSE}


sdm_envcmps20<-predict_sdm(sim_data$CompSparseSp20)

create_beta_plot(load_object("./gjam_models/gjam20cmps.rda"),cmps20,load_object("./new_HMmodels/hm20cmps.rda"),S$bchain,sdm_envcmps20$beta_sdm)

create_plot_response(sim_data$CompSparseSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc , pred_gjam_dr,sdm_envcmps20$pred_sdm)


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc,(-1)*comp_inter[[15]])

```


```{r all models tau cmps20, include=TRUE}

ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc,(-1)*comp_inter[[15]])

```







## Environmental filtering + Competition +Facilitation 5 dense species








### JSDM 

```{r model jsdm cmp_facd5, echo=FALSE,include=FALSE}
cmp_fd5 <- load_object("model-2019-04-19-13-08-47.rda")
summary(cmp_fd5)
jsdm_conv(cmp_fd5)
cmp_fd5$mcmc.info[1:7]

j_metric_FacCompDense5<-metrics_jsdm((!cmp_fd5$overlap0$Rho)*cmp_fd5$mean$Rho,comp = comp_inter[[16]],fac = fac_inter[[16]],only_env = F)
j_metric_FacCompDense5_p<-metrics_jsdm(jsdm_tau(cmp_fd5)$Tau_sign,comp = comp_inter[[16]],fac = fac_inter[[16]],only_env = F)

######################################################Prepare data
data<-sim_data$FacCompDenseSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
##Cor
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmp_fd5$mean$Rho*(!cmp_fd5$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmp_fd5)$Tau_sign) 
  
###Prediction
pred_j<-array(NA,dim=c(data$n,data$J,cmp_fd5$mcmc.info$n.samples))
for(i in 1:cmp_fd5$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmp_fd5$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

AUC_j_comp_fac_dense<-vector()
for(i in 1:data$J) AUC_j_comp_fac_dense<-c(AUC_j_comp_fac_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```




### Gjam



```{r gjam cmp_facd5,include=TRUE,echo=FALSE}
data<-sim_data$FacCompDenseSp5
#gjam_mod<-fit_gjam(data,20000,5000,"./gjam_models/gjam5cmp_facd2.rda",interact= (-1)*comp_inter[[16]]+fac_inter[[16]])
gjam_mod<-load_gjam(data,20000,5000,"./gjam_models/gjam5cmp_facd2.rda",interact= (-1)*comp_inter[[16]]+fac_inter[[16]])

g_metric_FacCompDense5<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[16]], fac=fac_inter[[16]], only_env = F)
g_metric_FacCompDense5_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[16]], fac=fac_inter[[16]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_FacCompDense5$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompDense5$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_FacCompDense5$success_fac,3)))

mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

AUC_g_comp_fac_dense<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_comp_fac_dense<-c(AUC_g_comp_fac_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

```





### HMSC




```{r hmsc cmp_facd5,echo=FALSE, include=TRUE}
data<-sim_data$FacCompDenseSp5
hm_mod<-fit_hmsc(data,"Load",nsamples=3000, nchains=2,name="./new_HMmodels/hmcmp_facd5.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=3000, nchains=2,interact =  (-1)*comp_inter[[16]]+ fac_inter[[16]])

h_metric_FacCompDense5<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[16]],fac= fac_inter[[16]],only_env = F)
h_metric_FacCompDense5_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[16]],fac= fac_inter[[16]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_FacCompDense5$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_FacCompDense5$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_FacCompDense5$success_fac,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

AUC_h_comp_fac_dense<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_comp_fac_dense<-c(AUC_h_comp_fac_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```


### Dimension reduction

```{r dimred comp_facd5, include=TRUE,echo=FALSE}

S<- gjam_dim_red_5(sim_data$FacCompDenseSp5,ng=10000, burnin=1000,name="./gjam_models/gjamDR5compfacd.rda", regime="L")
g_dr_metric_FacCompDense5<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[16]], fac=fac_inter[[16]], only_env = F)
g_dr_metric_FacCompDense5_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[16]], fac=fac_inter[[16]], only_env = F)

AUC_gdr_comp_fac_dense<-vector()

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacCompDenseSp5
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_fac_dense<-c(AUC_gdr_comp_fac_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)




par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot((-1)*comp_inter[[16]]+ fac_inter[[16]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```




```{r all models cmp_facd5, include=TRUE,warning=FALSE,message=FALSE}


sdm_envcmfd5<-predict_sdm(sim_data$FacCompDenseSp5)

create_beta_plot(load_object("./gjam_models/gjam5cmp_facd2.rda"),cmp_fd5,load_object("./new_HMmodels/hmcmp_facd5.rda"), S$bchain,sdm_envcmfd5$beta_sdm)

create_plot_response(sim_data$FacCompDenseSp5, nsp=5,pred_gjam, pred_jsdm,pred_hmsc , pred_gjam_dr,sdm_envcmfd5$pred_sdm)


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc, (-1)*comp_inter[[16]]+ fac_inter[[16]])

```


```{r all models tau cmp_facd5, include=TRUE}

ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc, (-1)*comp_inter[[16]]+ fac_inter[[16]])

```







## Environmental filtering + Competition +Facilitation 10 dense species









### JSDM 

```{r model jsdm cmp_facd10, echo=FALSE,include=FALSE}
cmp_fd10 <- load_object("model-2019-04-20-00-37-25.rda")
# 
summary(cmp_fd10)
jsdm_conv(cmp_fd10)
cmp_fd10$mcmc.info[1:7]
# 
j_metric_FacCompDense10<-metrics_jsdm((!cmp_fd10$overlap0$Rho)*cmp_fd10$mean$Rho,comp = comp_inter[[17]],fac = fac_inter[[17]],only_env = F)
j_metric_FacCompDense10_p<-metrics_jsdm(jsdm_tau(cmp_fd10)$Tau_sign,comp = comp_inter[[17]],fac = fac_inter[[17]],only_env = F)

# ######################################################Prepare data
data<-sim_data$FacCompDenseSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

#plot_cor_jsdm(cmp_fd10,data$Y,(-1)*comp_inter[[17]] +fac_inter[[17]] )

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmp_fd10$mean$Rho*(!cmp_fd10$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmp_fd10)$Tau_sign) 
  

pred_j<-array(NA,dim=c(data$n,data$J,cmp_fd10$mcmc.info$n.samples))
for(i in 1:cmp_fd10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmp_fd10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_fac_dense<-c(AUC_j_comp_fac_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

  
```

### Gjam

```{r gjam cmp_facd10,include=TRUE,echo=FALSE}
data<-sim_data$FacCompDenseSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjamcmp_facd10.rda",interact=  (-1)*comp_inter[[17]]+fac_inter[[17]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjamcmp_facd10.rda", interact= (-1)*comp_inter[[17]]+fac_inter[[17]])

g_metric_FacCompDense10<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[17]], fac=fac_inter[[17]], only_env = F)
g_metric_FacCompDense10_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[17]], fac=fac_inter[[17]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_FacCompDense10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompDense10$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_FacCompDense10$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_fac_dense<-c(AUC_g_comp_fac_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```


### HMSC

```{r hmsc cmp_facd10,echo=FALSE, include=TRUE}
  
hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hmcmp_facd10.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[17]] + fac_inter[[17]])

h_metric_FacCompDense10<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[17]],fac=fac_inter[[17]], only_env = F)
h_metric_FacCompDense10_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[17]],fac=fac_inter[[17]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_FacCompDense10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_FacCompDense10$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_FacCompDense10$success_fac,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)

x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_fac_dense<-c(AUC_h_comp_fac_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```

### Dimension reduction



```{r dim red faccompd10,include=TRUE, echo=FALSE}

#r-opt=5
S<- gjam_dim_red(sim_data$FacCompDenseSp10,ng=10000, burnin=1000,r=5,name="./gjam_models/gjamDR10compfacd.rda", regime="L")
g_dr_metric_FacCompDense10<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[17]], fac=fac_inter[[17]], only_env = F)
g_dr_metric_FacCompDense10_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[17]], fac=fac_inter[[17]], only_env = F)

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacCompDenseSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_fac_dense<-c(AUC_gdr_comp_fac_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)



par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot((-1)*comp_inter[[17]]+ fac_inter[[17]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




```{r all models cmp_facd10, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmfd10<-predict_sdm(sim_data$FacCompDenseSp10)

create_beta_plot(load_object("./gjam_models/gjamcmp_facd10.rda"),cmp_fd10,load_object("./new_HMmodels/hmcmp_facd10.rda"),S$bchain,sdm_envcmfd10$beta_sdm)

create_plot_response(sim_data$FacCompDenseSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr ,sdm_envcmfd10$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc, (-1)*comp_inter[[17]]+ fac_inter[[17]])

```


```{r all models tau cmp_facd10, include=TRUE}


ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc, (-1)*comp_inter[[17]]+ fac_inter[[17]])

```






## Environmental filtering + Competition +Facilitation 20 dense species








### JSDM 





```{r model jsdm cmp_facd20, echo=FALSE,include=FALSE}

cmp_fd20 <- load_object("model-2019-04-21-11-10-34.rda")

summary(cmp_fd20)
jsdm_conv(cmp_fd20)
cmp_fd20$mcmc.info[1:7]
# 
j_metric_FacCompDense20<-metrics_jsdm((!cmp_fd20$overlap0$Rho)*cmp_fd20$mean$Rho,comp = comp_inter[[18]],fac = fac_inter[[18]],only_env = F)
j_metric_FacCompDense20_p<-metrics_jsdm(jsdm_tau(cmp_fd20)$Tau_sign,comp = comp_inter[[18]],fac = fac_inter[[18]],only_env = F)

# ######################################################Prepare data
data<-sim_data$FacCompDenseSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmp_fd20$mean$Rho*(!cmp_fd20$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmp_fd20)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,cmp_fd20$mcmc.info$n.samples))
for(i in 1:cmp_fd20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmp_fd20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)


for(i in 1:data$J) AUC_j_comp_fac_dense<-c(AUC_j_comp_fac_dense,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

   
```




### Gjam



```{r gjam cmp_facd20,include=TRUE,echo=FALSE}
data<-sim_data$FacCompDenseSp20
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjamcmp_facd20.rda",interact=  (-1)*comp_inter[[18]]+fac_inter[[18]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjamcmp_facd20.rda", interact= (-1)*comp_inter[[18]]+fac_inter[[18]])

g_metric_FacCompDense20<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[18]], fac=fac_inter[[18]], only_env = F)
g_metric_FacCompDense20_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[18]], fac=fac_inter[[18]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_FacCompDense20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompDense20$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_FacCompDense20$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_fac_dense<-c(AUC_g_comp_fac_dense,auc(roc(pred_gj_mean[,i],factor(data[,i]))))

```


### HMSC

```{r hmsc cmp_facd20, include=TRUE, echo=FALSE}
data<-sim_data$FacCompDenseSp20
hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hmcmp_facd20.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[18]] + fac_inter[[18]])
h_metric_FacCompDense20<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[18]],fac=fac_inter[[18]],only_env = F)
h_metric_FacCompDense20_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[18]],fac=fac_inter[[18]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_FacCompDense20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_FacCompDense20$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_FacCompDense20$success_fac,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_fac_dense<-c(AUC_h_comp_fac_dense,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```


### Dimension reduction

```{r dim red faccompd20, include=TRUE, echo=FALSE}

#r-opt=5
S<- gjam_dim_red(sim_data$FacCompDenseSp20,ng=10000, burnin=1000,r=3,name="./gjam_models/gjamDR20compfacd.rda", regime="L")
g_dr_metric_FacCompDense20<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[18]], fac=fac_inter[[18]], only_env = F)
g_dr_metric_FacCompDense20_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[18]], fac=fac_inter[[18]], only_env = F)

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacCompDenseSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_fac_dense<-c(AUC_gdr_comp_fac_dense,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)



par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot((-1)*comp_inter[[18]]+ fac_inter[[18]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```



```{r all models cmp_facd20, include=TRUE,warning=FALSE,message=FALSE}


sdm_envcmfd20<-predict_sdm(sim_data$FacCompDenseSp20)

create_beta_plot(load_object("./gjam_models/gjamcmp_facd20.rda"),cmp_fd20,load_object("./new_HMmodels/hmcmp_facd20.rda"),S$bchain,sdm_envcmfd20$beta_sdm)

create_plot_response(sim_data$FacCompDenseSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envcmfd20$pred_sdm )

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc, (-1)*comp_inter[[18]]+ fac_inter[[18]])

```

```{r all models tau cmp_facd20, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc, (-1)*comp_inter[[18]]+ fac_inter[[18]])

```








## Environmental filtering + Competition +Facilitation 5 sparse species








### JSDM 

```{r model jsdm cmp_facs5, echo=FALSE,include=FALSE}
cmp_fds5 <- load_object("model-2019-04-21-11-39-52.rda")
# 
summary(cmp_fds5)
jsdm_conv(cmp_fds5)
cmp_fds5$mcmc.info[1:7]
# 
j_metric_FacCompSparse5<-metrics_jsdm((!cmp_fds5$overlap0$Rho)*cmp_fds5$mean$Rho,comp = comp_inter[[19]],fac = fac_inter[[19]],only_env = F)
j_metric_FacCompSparse5_p<-metrics_jsdm(jsdm_tau(cmp_fds5)$Tau_sign,comp = comp_inter[[19]],fac = fac_inter[[19]],only_env = F)
# ######################################################Prepare data
data<-sim_data$FacCompSparseSp5
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
#####Correlation
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmp_fds5$mean$Rho*(!cmp_fds5$overlap0$Rho)) 
mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmp_fds5)$Tau_sign)  
##Prediction
pred_j<-array(NA,dim=c(data$n,data$J,cmp_fds5$mcmc.info$n.samples))
for(i in 1:cmp_fds5$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmp_fds5$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

AUC_j_comp_fac_sparse<-vector()
for(i in 1:data$J) AUC_j_comp_fac_sparse<-c(AUC_j_comp_fac_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

    
```

### Gjam

```{r gjam cmp_facs5,include=TRUE,echo=FALSE}
data<-sim_data$FacCompSparseSp5
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjamcmp_facs5.rda",interact= (-1)*comp_inter[[19]]+ fac_inter[[19]] )
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjamcmp_facs5.rda", interact=  (-1)*comp_inter[[19]]+ fac_inter[[19]])
g_metric_FacCompSparse5<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[19]], fac=fac_inter[[19]], only_env = F)
g_metric_FacCompSparse5_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[19]], fac=fac_inter[[19]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_FacCompSparse5$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompSparse5$success_comp,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompSparse5$success_comp,3)))
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

AUC_g_comp_fac_sparse<-vector()
for(i in 1:(ncol(data)-1)) AUC_g_comp_fac_sparse<-c(AUC_g_comp_fac_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```


### HMSC

```{r hmsc cmp_facs5,echo=FALSE, include=TRUE}
data<-sim_data$FacCompSparseSp5
hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hmcmp_facs5.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[19]]+ fac_inter[[19]])
 
h_metric_FacCompSparse5<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[19]],fac= fac_inter[[19]] ,only_env = F)
h_metric_FacCompSparse5_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[19]],fac= fac_inter[[19]] ,only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_FacCompSparse5$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_FacCompSparse5$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_FacCompSparse5$success_fac,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)


x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}
pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

AUC_h_comp_fac_sparse<-vector()
for(i in 1:(ncol(data)-1)) AUC_h_comp_fac_sparse<-c(AUC_h_comp_fac_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```



### Dimension reduction






```{r dimred compfacs5, include=TRUE,echo=FALSE}

S<- gjam_dim_red_5(sim_data$FacCompSparseSp5,ng=10000, burnin=1000,name="./gjam_models/gjamDR5compfacs.rda", regime="L")
g_dr_metric_FacCompSparse5<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[19]], fac=fac_inter[[19]], only_env = F)
g_dr_metric_FacCompSparse5_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[19]], fac=fac_inter[[19]], only_env = F)

AUC_gdr_comp_fac_sparse<-vector()

##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacCompSparseSp5
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_fac_sparse<-c(AUC_gdr_comp_fac_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)




par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dim. reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dim. reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200), type = "lower")
title("Posterior clusters from dim. reduction")
corrplot( (-1)*comp_inter[[19]]+ fac_inter[[19]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")

```


```{r all models cmp_facs5, include=TRUE,warning=FALSE,message=FALSE}


sdm_envcmfs5<-predict_sdm(sim_data$FacCompSparseSp5)

create_beta_plot(load_object("./gjam_models/gjamcmp_facs5.rda"),cmp_fds5,load_object("./new_HMmodels/hmcmp_facs5.rda" ),S$bchain,sdm_envcmfs5$beta_sdm)

create_plot_response(sim_data$FacCompSparseSp5, nsp=5,pred_gjam, pred_jsdm,pred_hmsc ,pred_gjam_dr,sdm_envcmfs5$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc, (-1)*comp_inter[[19]]+ fac_inter[[19]])

```


```{r all models tau cmp_facs5, include=TRUE}
ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc, (-1)*comp_inter[[19]]+ fac_inter[[19]])

```









## Environmental filtering + Competition +Facilitation 10 sparse species






### JSDM 





```{r model jsdm cmp_facs10, echo=FALSE,include=FALSE}
cmp_fds10 <- load_object("model-2019-04-21-22-58-58.rda")
#
summary(cmp_fds10)
jsdm_conv(cmp_fds10)
cmp_fds10$mcmc.info[1:7]
# 
j_metric_FacCompSparse10<-metrics_jsdm((!cmp_fds10$overlap0$Rho)*cmp_fds10$mean$Rho,comp = comp_inter[[20]],fac = fac_inter[[20]],only_env = F)
j_metric_FacCompSparse10_p<-metrics_jsdm(jsdm_tau(cmp_fds10)$Tau_sign,comp = comp_inter[[20]],fac = fac_inter[[20]],only_env = F)

# ######################################################Prepare data
data<-sim_data$FacCompSparseSp10
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)
########Correlation
mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmp_fds10$mean$Rho*(!cmp_fds10$overlap0$Rho)) 

mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmp_fds10)$Tau_sign) 
########Prediction
pred_j<-array(NA,dim=c(data$n,data$J,cmp_fds10$mcmc.info$n.samples))
for(i in 1:cmp_fds10$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmp_fds10$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)


pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_fac_sparse<-c(AUC_j_comp_fac_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))


```





### Gjam






```{r gjam cmp_facs10,include=TRUE,echo=FALSE}
data<-sim_data$FacCompSparseSp10
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjamcmp_facs10.rda",interact= (-1)*comp_inter[[20]] +fac_inter[[20]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjamcmp_facs10.rda", interact=  (-1)*comp_inter[[20]] +fac_inter[[20]])

g_metric_FacCompSparse10<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[20]],fac=fac_inter[[20]], only_env = F)
g_metric_FacCompSparse10_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[20]],fac=fac_inter[[20]], only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_FacCompSparse10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompSparse10$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_FacCompSparse10$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 

pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_fac_sparse<-c(AUC_g_comp_fac_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```




### HMSC





```{r hmsc cmp_facs10,echo=FALSE, include=TRUE}
data<-sim_data$FacCompSparseSp10
hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hmcmp_facs10.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[20]] +fac_inter[[20]])

h_metric_FacCompSparse10<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[20]],fac=fac_inter[[20]],only_env = F)
h_metric_FacCompSparse10_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[20]],fac=fac_inter[[20]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_FacCompSparse10$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_FacCompSparse10$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_FacCompSparse10$success_fac,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)
#Prediction
x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}

pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_fac_sparse<-c(AUC_h_comp_fac_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))
```




### Dimension reduction





```{r dim red faccomps10, include=TRUE, echo=FALSE}

#r-opt=5
S<- gjam_dim_red(sim_data$FacCompSparseSp10,ng=10000, burnin=1000,r=5,name="./gjam_models/gjamDR10compfacs.rda", regime="L")
g_dr_metric_FacCompSparse10<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[20]],fac=fac_inter[[20]], only_env = F)
g_dr_metric_FacCompSparse10_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[20]],fac=fac_inter[[20]], only_env = F)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacCompSparseSp10
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_fac_sparse<-c(AUC_gdr_comp_fac_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)



par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot((-1)*comp_inter[[20]]+ fac_inter[[20]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




### Summary plots





```{r all models cmp_facs10, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmfs10<-predict_sdm(sim_data$FacCompSparseSp10)


create_beta_plot(load_object("./gjam_models/gjamcmp_facs10.rda"),cmp_fds10,load_object("./new_HMmodels/hmcmp_facs10.rda"),S$bchain,sdm_envcmfs10$beta_sdm)

create_plot_response(sim_data$FacCompSparseSp10, nsp=10,pred_gjam, pred_jsdm,pred_hmsc ,pred_gjam_dr,sdm_envcmfs10$pred_sdm)

ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc, (-1)*comp_inter[[20]]+ fac_inter[[20]])

```


```{r all models tau cmp_facs10, include=TRUE}


ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc, (-1)*comp_inter[[20]]+ fac_inter[[20]])

```








## Environmental filtering + Competition +Facilitation 20 sparse species







### JSDM 





```{r model jsdm cmp_facs20, echo=FALSE,include=FALSE}
cmp_fds20 <- load_object("model-2019-04-23-09-42-18.rda")

summary(cmp_fds20)
jsdm_conv(cmp_fds20)
cmp_fds20$mcmc.info[1:7]
# 
j_metric_FacCompSparse20<-metrics_jsdm((!cmp_fds20$overlap0$Rho)*cmp_fds20$mean$Rho,comp = comp_inter[[21]],fac = fac_inter[[21]],only_env = F)
j_metric_FacCompSparse20_p<-metrics_jsdm(jsdm_tau(cmp_fds20)$Tau_sign,comp = comp_inter[[21]],fac = fac_inter[[21]],only_env = F)

# 
# ######################################################Prepare data
data<-sim_data$FacCompSparseSp20
data <- list(
  Y = subset(data, select = -env),
  X = cbind(1, scale(poly(data$env, 2))),
  covx = cov(cbind(1, scale(poly(data$env, 2)))),
  K = 3,
  J = ncol(data) - 1,
  n = nrow(data),
  I = diag(ncol(data) - 1),
  df = ncol(data)
)

#plot_cor_jsdm(cmp_fds20,data$Y,(-1)*comp_inter[[21]] +fac_inter[[21]] )

mod_list_Rho<-list()
mod_list_Rho<-list(jsdm =cmp_fds20$mean$Rho*(!cmp_fds20$overlap0$Rho)) 
 
mod_list_Tau<-list()
mod_list_Tau<-list(jsdm =jsdm_tau(cmp_fds20)$Tau_sign) 

pred_j<-array(NA,dim=c(data$n,data$J,cmp_fds20$mcmc.info$n.samples))
for(i in 1:cmp_fds20$mcmc.info$n.samples){
  
  pred_j[,,i]<-pnorm(data$X%*%t(cmp_fds20$sims.list$B[i,,]))
  
}

pred_j_mean <- apply(pred_j, 1:2, mean)
pred_j_05 <- apply(pred_j, 1:2, quantile,0.05)
pred_j_95 <- apply(pred_j, 1:2, quantile,0.95)

pred_jsdm<-list(pred_j_mean=pred_j_mean,pred_j_05=pred_j_05,pred_j_95=pred_j_95)

for(i in 1:data$J) AUC_j_comp_fac_sparse<-c(AUC_j_comp_fac_sparse,auc(roc(pred_j_mean[,i],factor(data$Y[,i]))))

```




### Gjam





```{r gjam cmp_facs20,results=FALSE, include=TRUE}
data<-sim_data$FacCompSparseSp20
#gjam_mod<-fit_gjam(data,10000,1000,"./gjam_models/gjamcmp_facs20.rda",interact= (-1)*comp_inter[[21]]+fac_inter[[21]])
gjam_mod<-load_gjam(data,10000,1000,name="./gjam_models/gjamcmp_facs20.rda", interact= (-1)*comp_inter[[21]]+fac_inter[[21]])
g_metric_FacCompSparse20<-metrics_gjam(gjam_mod$Rho_sign,comp=comp_inter[[21]], fac=fac_inter[[21]],only_env = F)
g_metric_FacCompSparse20_p<-metrics_gjam(gjam_mod$Tau_sign,comp=comp_inter[[21]], fac=fac_inter[[21]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(g_metric_FacCompSparse20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(g_metric_FacCompSparse20$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(g_metric_FacCompSparse20$success_fac,3)))
mod_list_Rho<-list.append(mod_list_Rho, gjam=gjam_mod$Rho_sign) 
mod_list_Tau<-list.append(mod_list_Tau, gjam=gjam_mod$Tau_sign) 


pred_gj_mean <-apply(gjam_mod$predict, 1:2,mean)
pred_gj_05 <- apply(gjam_mod$predict, 1:2,quantile,0.05)
pred_gj_95 <- apply(gjam_mod$predict, 1:2,quantile,0.95)

pred_gjam<- list(pred_gj_mean=pred_gj_mean,pred_gj_05=pred_gj_05,pred_gj_95=pred_gj_95)

for(i in 1:(ncol(data)-1)) AUC_g_comp_fac_sparse<-c(AUC_g_comp_fac_sparse,auc(roc(pred_gj_mean[,i],factor(data[,i]))))
```




### HMSC




```{r hmsc cmp_facs20, echo=FALSE, include=TRUE}
data<-sim_data$FacCompSparseSp20
hm_mod<-fit_hmsc(data,"Load",nsamples=2000, nchains=2,name="./new_HMmodels/hmcmp_facs20.rda" )
hm_conv(hm_mod)
hm_mod_R<-hm_inter(hm_mod, nsamples=2000, nchains=2,interact =  (-1)*comp_inter[[21]] +fac_inter[[21]])
h_metric_FacCompSparse20<-metrics_hmsc(hm_mod_R$Rho_sign,comp=comp_inter[[21]],fac=fac_inter[[21]],only_env = F)
h_metric_FacCompSparse20_p<-metrics_hmsc(hm_mod_R$Tau_sign,comp=comp_inter[[21]],fac=fac_inter[[21]],only_env = F)

cat("\n")
cat(sprintf("Success rate for non-interacting: %s\n", round(h_metric_FacCompSparse20$success_env,3)))
cat(sprintf("Success rate for competition: %s\n", round(h_metric_FacCompSparse20$success_comp,3)))
cat(sprintf("Success rate for facilitation: %s\n", round(h_metric_FacCompSparse20$success_fac,3)))
#mod_list<-list.append(mod_list,hmsc=Rho_sign)
mod_list_Rho<-list.append(mod_list_Rho,hmsc=hm_mod_R$Rho_sign)
mod_list_Tau<-list.append(mod_list_Tau,hmsc=hm_mod_R$Tau_sign)
####Prediction
x = cbind(1, scale(poly(data$env, 2)))
pred_hm<-array(NA,dim=c(hm_mod$ny,hm_mod$ns,2*hm_mod$samples)) #2 is nchains
for(k in 1:(2*hm_mod$samples)){
    if(k<=hm_mod$samples){pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[1]][[k]]$Beta)
    }else {pred_hm[,,k] <- pnorm(x%*%hm_mod$postList[[2]][[k-hm_mod$samples]]$Beta)}

}
pred_hmsc<- list(pred_hm_mean=apply(pred_hm, c(1,2), mean),
                 pred_hm_05=apply(pred_hm, c(1,2), quantile,0.05),
                 pred_hm_95=apply(pred_hm, c(1,2), quantile,0.95))

for(i in 1:(ncol(data)-1)) AUC_h_comp_fac_sparse<-c(AUC_h_comp_fac_sparse,auc(roc(pred_hmsc$pred_hm_mean[,i],factor(data[,i]))))

```





### Dimension reduction



```{r dim red  faccoms20, include=TRUE, echo=FALSE}

#r-opt=15
S<- gjam_dim_red(sim_data$FacCompSparseSp20,ng=10000, burnin=1000,r=3,name="./gjam_models/gjamDR20compfacs.rda", regime="L")
g_dr_metric_FacCompSparse20<-metrics_gjam(S$Rho_sign_d,comp=comp_inter[[21]], fac=fac_inter[[21]],only_env = F)
g_dr_metric_FacCompSparse20_p<-metrics_gjam(S$Tau_sign_d,comp=comp_inter[[21]], fac=fac_inter[[21]],only_env = F)


##Prediction
pred_gj_dr_mean <-apply(S$predict, 1:2,mean)
pred_gj_dr_05 <- apply(S$predict, 1:2,quantile,0.05)
pred_gj_dr_95 <- apply(S$predict, 1:2,quantile,0.95)
data<-sim_data$FacCompSparseSp20
for(i in 1:(ncol(data)-1)) AUC_gdr_comp_fac_sparse<-c(AUC_gdr_comp_fac_sparse,auc(roc(pred_gj_dr_mean[,i],factor(data[,i]))))
pred_gjam_dr<- list(pred_gj_dr_mean=pred_gj_dr_mean,pred_gj_dr_05=pred_gj_dr_05,pred_gj_dr_95=pred_gj_dr_95)


par(mfrow=c(2,2),oma = c(1, 1, 1, 1))
corrplot(S$Rho_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Correlation from dimension reduction")
corrplot(S$Tau_sign_d, diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot(comp.psm(S$k), diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=gcols(200),cl.lim=c(0, 1), type = "lower")
title("Partial Correlation from dimension reduction")
corrplot((-1)*comp_inter[[21]]+fac_inter[[21]], diag = FALSE, order = "original",tl.pos = "ld", tl.cex = 0.5, method = "color",col=cols(200), type = "lower")
title("True interactions")


```




### Summary plots




```{r all models cmp_facs20, include=TRUE,warning=FALSE,message=FALSE}

sdm_envcmfs20<-predict_sdm(sim_data$FacCompSparseSp20)


create_beta_plot(load_object("./gjam_models/gjamcmp_facs20.rda"),cmp_fds20,load_object("./new_HMmodels/hmcmp_facs20.rda"), S$bchain,sdm_envcmfs20$beta_sdm)

create_plot_response(sim_data$FacCompSparseSp20, nsp=20,pred_gjam, pred_jsdm,pred_hmsc,pred_gjam_dr,sdm_envcmfs20$pred_sdm )


ALL3(mod_list_Rho$jsdm,mod_list_Rho$gjam,mod_list_Rho$hmsc, (-1)*comp_inter[[21]]+ fac_inter[[21]])

```







```{r all models tau cmp_facs20, include=TRUE}


ALL4(mod_list_Tau$jsdm,mod_list_Tau$gjam,mod_list_Tau$hmsc, (-1)*comp_inter[[21]]+ fac_inter[[21]])

```






## Average interactions 






```{r combined models, echo=FALSE, warning=FALSE,include=TRUE}

models<-list(EnvEvenSp5=me5,EnvEvenSp10=me10, EnvEvenSp20=me20,FacDenseSp5 =mfd5, FacDenseSp10=mfd10, FacDenseSp20=mfd20,
              FacSparseSp5 =mfs5, FacSparseSp10=mfs10, FacSparseSp20=mfs20, CompDenseSp5=mcmpd5,CompDenseSp10=mcmpd10,CompDenseSp20=mcmpd20,
              CompSparseSp5=cmps5,      CompSparseSp10 =cmps10,   CompSparseSp20 =cmps20,   FacCompDenseSp5=cmp_fd5,FacCompDenseSp10=cmp_fd10,       
              FacCompDenseSp20 =cmp_fd20,FacCompSparseSp5=cmp_fds5,  FacCompSparseSp10=cmp_fds10, FacCompSparseSp20=cmp_fds20)



 mean_cor<-function(mod){
   mean_correlations <- do.call(
   rbind,
   lapply(
     seq_along(mod),
     function(i) {
       x <- models[[i]]
       nm <- strsplit(
         names(models)[[i]], "(?<=[a-z])(?=[A-Z])", perl = TRUE
       )[[1]]
       nsp <- ncol(x$mean$Rho)
       ut <- upper.tri(x$mean$Rho)
       sp <- arrayInd(which(ut), c(nsp, nsp))
       ans <- data.frame(
         model = i,
         sp1 = sp[, 1],
         sp2 = sp[, 2],
         rho = c(prob_cooccur_es(x$model$cluster1$data()$Y)[ut], x$mean$Rho[ut]),
         rho_type = rep(c("Effect-Size", "Residual"), each = sum(ut)),
         sgn = sign(x$mean$Rho)[ut],
         significant = x$overlap$Rho[ut],
         #cint = simulation_parameters$comp_inter[[i]][ut],
         #fint = simulation_parameters$fac_inter[[i]][ut],
         cint = comp_inter[[i]][ut],
         fint = fac_inter[[i]][ut],
         density = tail(nm, 2)[1],
         type = paste0(head(nm, -2), collapse = ""),
         nsp = nsp,
         stringsAsFactors = FALSE
       )
       ans$cint[is.na(ans$cint)] <- 0
       ans$fint[is.na(ans$fint)] <- 0
       ans$density[ans$density == "Even"] <- "None"
       ans$density <- factor(ans$density, c("None", "Sparse", "Dense"))
       ans$type[ans$type == "Env"] <- "Environmental\nFiltering Only"
       ans$type[ans$type == "Fac"] <- "Facilitation"
       ans$type[ans$type == "Comp"] <- "Competition"
       ans$type[ans$type == "FacComp"] <- "Facililation +\nCompetition"
       ans$type <- factor(
         ans$type,
         c(
           "Environmental\nFiltering Only", "Facilitation", "Competition",
           "Facililation +\nCompetition"
         )
       )
       ans$interaction <- "None"
       ans$interaction <- ifelse(ans$cint, "Competition", ans$interaction)
       ans$interaction <- ifelse(ans$fint, "Facilitation", ans$interaction)
       ans$status <- ifelse(
         ans$significant,
         ifelse(ans$sgn * -ans$cint == 1 | ans$sgn * ans$fint == 1, "TP", "FP"),
         ifelse(ans$cint == 0 & ans$fint == 0, "TN", "FN")
       )
       ans$interaction <- factor(
         ans$interaction, c("None", "Facilitation", "Competition")
       )
       ans
     }
   )
 )
  return(mean_correlations)
 }

 

 mean_correlations <- mean_cor(models)
 x <- subset(mean_correlations, type != "Environmental\nFiltering Only")
 acc <- by(x, x$model, function(x) sum(x$status == "TP" | x$status == "TN") / nrow(x))

 #' Plot correlation parameter means
 #+ plot-correlations
m<- ggplot(mean_correlations) +
   aes(factor(nsp), rho, fill = interaction) +
   geom_hline(yintercept = 0) +
   geom_boxplot(
     outlier.size = .2, size = .1, position = position_dodge(preserve = "single")
   ) +
   scale_fill_manual(values = c("grey", "blue", "red")) +
   facet_grid(rho_type ~ type + density) +
   xlab("Number of species") +
   ylab("Correlation") +
   theme_bw() +
   theme(legend.position = "top")
m




 

all<-list("j_metric_e5"=j_metric_e5,"g_metric_e5"=g_metric_e5,"g_dr_metric_e5"=g_dr_metric_e5,"h_metric_e5"=h_metric_e5,
          "j_metric_e10"=j_metric_e10,"g_metric_e10"=g_metric_e10,"g_dr_metric_e10"=g_dr_metric_e10,"h_metric_e10"=h_metric_e10,
          "j_metric_e20"=j_metric_e20,"g_metric_e20"=g_metric_e20,"g_dr_metric_e20"=g_dr_metric_e20,"h_metric_e20"=h_metric_e20,
          "h_metric_facDense5"=h_metric_facDense5,"g_metric_facDense5"=g_metric_facDense5,"g_dr_metric_facDense5"=g_dr_metric_facDense5,"j_metric_facDense5"=j_metric_facDense5,
          "h_metric_facDense10"=h_metric_facDense10,"g_metric_facDense10"=g_metric_facDense10,"g_dr_metric_facDense10"=g_dr_metric_facDense10,"j_metric_facDense10"=j_metric_facDense10,
          "h_metric_facDense20"=h_metric_facDense20,"g_metric_facDense20"=g_metric_facDense20,"g_dr_metric_facDense20"=g_dr_metric_facDense20,"j_metric_facDense20"=j_metric_facDense20,
          "h_metric_facSparse5"=h_metric_facSparse5,"g_metric_facSparse5"=g_metric_facSparse5,"g_dr_metric_facSparse5"=g_dr_metric_facSparse5,"j_metric_facSparse5"=j_metric_facSparse5,
          "h_metric_facSparse10"=h_metric_facSparse10,"g_metric_facSparse10"=g_metric_facSparse10,"g_dr_metric_facSparse10"=g_dr_metric_facSparse10,"j_metric_facSparse10"=j_metric_facSparse10,
          "h_metric_facSparse20"=h_metric_facSparse20,"g_metric_facSparse20"=g_metric_facSparse20,"g_dr_metric_facSparse20"=g_dr_metric_facSparse20,"j_metric_facSparse20"=j_metric_facSparse20,
          "h_metric_compDense5"=h_metric_compDense5,"g_metric_compDense5"=g_metric_compDense5,"g_dr_metric_compDense5"=g_dr_metric_compDense5,"j_metric_compDense5"=j_metric_compDense5,
          "h_metric_compDense10"=h_metric_compDense10,"g_metric_compDense10"=g_metric_compDense10,"g_dr_metric_compDense10"=g_dr_metric_compDense10,"j_metric_compDense10"=j_metric_compDense10,
          "h_metric_compDense20"=h_metric_compDense20,"g_metric_compDense20"=g_metric_compDense20,"g_dr_metric_compDense20"=g_dr_metric_compDense20,"j_metric_compDense20"=j_metric_compDense20,
          "h_metric_compSparse5"=h_metric_compSparse5,"g_metric_compSparse5"=g_metric_compSparse5,"g_dr_metric_compSparse5"=g_dr_metric_compSparse5,"j_metric_compSparse5"=j_metric_compSparse5,
          "h_metric_compSparse10"=h_metric_compSparse10,"g_metric_compSparse10"=g_metric_compSparse10,"g_dr_metric_compSparse10"=g_dr_metric_compSparse10,"j_metric_compSparse10"=j_metric_compSparse10,
          "h_metric_compSparse20"=h_metric_compSparse20,"g_metric_compSparse20"=g_metric_compSparse20,"g_dr_metric_compSparse20"=g_dr_metric_compSparse20,"j_metric_compSparse20"=j_metric_compSparse20,
          "g_metric_faccompSparseSp5"= g_metric_FacCompSparse5,"h_metric_faccompSparseSp5"=h_metric_FacCompSparse5,"g_dr_metric_FacCompSparse5"=g_dr_metric_FacCompSparse5, "j_metric_faccompSparseSp5"=j_metric_FacCompSparse5,
          "g_metric_faccompSparseSp10"= g_metric_FacCompSparse10,"h_metric_faccompSparseSp10"=h_metric_FacCompSparse10,"g_dr_metric_FacCompSparse10"=g_dr_metric_FacCompSparse10, "j_metric_faccompSparseSp10"=j_metric_FacCompSparse10,
          "g_metric_faccompSparseSp20"= g_metric_FacCompSparse20,"h_metric_faccompSparseSp20"=h_metric_FacCompSparse20, "g_dr_metric_FacCompSparse20"=g_dr_metric_FacCompSparse20,"j_metric_faccompSparseSp20"=j_metric_FacCompSparse20,
          "g_metric_faccompDenseSp5"= g_metric_FacCompDense5,"g_dr_metric_FacCompDense5"=g_dr_metric_FacCompDense5,"h_metric_faccompDenseSp5"=h_metric_FacCompDense5, "j_metric_faccompDenseSp5"=j_metric_FacCompDense5,
          "g_metric_faccompDenseSp10"= g_metric_FacCompDense10,"g_dr_metric_FacCompDense10"=g_dr_metric_FacCompDense10,"h_metric_faccompDenseSp10"=h_metric_FacCompDense10, "j_metric_faccompDenseSp10"=j_metric_FacCompDense10,
          "g_metric_faccompDenseSp20"= g_metric_FacCompDense20,"g_dr_metric_FacCompDense20"=g_dr_metric_FacCompDense20,"h_metric_faccompDenseSp20"=h_metric_FacCompDense20, "j_metric_faccompDenseSp20"=j_metric_FacCompDense20
        )


          
table<-as.data.frame(matrix(NA,nrow=63, ncol=8,dimnames=list(NULL,c("success_env","success_comp","success_fac","n_sp","Facilitation","Competition","sparsity","model"))))
                                                  
for(i in 1:length(names(all))){
  if(!is.null(all[[i]]$success_env)) table[i,"success_env"]<-all[[i]]$success_env
  if(!is.null(all[[i]]$success_comp)) table[i,"success_comp"]<-all[[i]]$success_comp
  if(!is.null(all[[i]]$success_fac)) table[i,"success_fac"]<-all[[i]]$success_fac
  
  if(length(grep("5",names(all)[i]))>0) table[i,"n_sp"]<-5
  if(length(grep("10",names(all)[i]))>0) table[i,"n_sp"]<-10
  if(length(grep("20",names(all)[i]))>0) table[i,"n_sp"]<-20
  
  if(length(grep("fac",names(all)[i]))>0){ table[i,"Facilitation"]<-"facilitation"}#else{table[i,"facilition"]<-NULL}
  if(length(grep("comp",names(all)[i]))>0){ table[i,"Competition"]<-"competition"}#else{table[i,"competition"]<-NULL}
  #if(!(length(grep("comp",names(all)[i]))>0) | length(grep("fac",names(all)[i]))>0) {table[i,"Comp_fac"]<-"comp_fac"}else{table[i,"Comp_fac"]<-NULL}
  
  
  if(length(grep("Dense",names(all)[i]))>0){ table[i,"sparsity"]<-"dense"}else{table[i,"sparsity"]<-"sparse"}
  
  if(length(grep("j_",names(all)[i]))>0) table[i,"model"]<-"CM"
  if(length(grep("g_m",names(all)[i]))>0) table[i,"model"]<-"GJAM"
  if(length(grep("g_d",names(all)[i]))>0) table[i,"model"]<-"DR-GJAM"
  if(length(grep("h_",names(all)[i]))>0) table[i,"model"]<-"HMSC"
  
}

table_comp<-table[which(!is.na(table$success_comp)),]
table_fac<-table[which(!is.na(table$success_fac)),]

tc<-cbind(table_comp$success_comp,table_comp$model,rep("All",nrow(table_comp)),rep("Int",nrow(table_comp)))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==5),"success_comp"],table_comp[which(table_comp$n_sp==5),"model"],rep("5",sum(table_comp$n_sp==5)),rep("Int",sum(table_comp$n_sp==5))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==10),"success_comp"],table_comp[which(table_comp$n_sp==10),"model"],rep("10",sum(table_comp$n_sp==10)),rep("Int",sum(table_comp$n_sp==10))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==20),"success_comp"],table_comp[which(table_comp$n_sp==20),"model"],rep("20",sum(table_comp$n_sp==20)),rep("Int",sum(table_comp$n_sp==20))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$sparsity=="dense"),"success_comp"],table_comp[which(table_comp$sparsity=="dense"),"model"],rep("dense",sum(table_comp$sparsity=="dense")),rep("Int",sum(table_comp$sparsity=="dense"))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$sparsity=="sparse"),"success_comp"],table_comp[which(table_comp$sparsity=="sparse"),"model"],rep("sparse",sum(table_comp$sparsity=="sparse")),rep("Int",sum(table_comp$sparsity=="sparse"))))
tc<-rbind(tc,cbind(table_comp$success_env,table_comp$model,rep("All_env",nrow(table_comp)),rep("Env",nrow(table_comp))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==5),"success_env"],table_comp[which(table_comp$n_sp==5),"model"],rep("5_env",sum(table_comp$n_sp==5)),rep("Env",sum(table_comp$n_sp==5))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==10),"success_env"],table_comp[which(table_comp$n_sp==10),"model"],rep("10_env",sum(table_comp$n_sp==10)),rep("Env",sum(table_comp$n_sp==10))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==20),"success_env"],table_comp[which(table_comp$n_sp==20),"model"],rep("20_env",sum(table_comp$n_sp==20)),rep("Env",sum(table_comp$n_sp==20))))

tc<-data.frame("success"=as.numeric(tc[,1]),"model"=tc[,2],"fac"=tc[,3],"int"=rep("Competition",nrow(tc)),"col"=tc[,4])



tf<-cbind(table_fac$success_fac,table_fac$model,rep("All",nrow(table_fac)),rep("Int",nrow(table_fac)))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==5),"success_fac"],table_fac[which(table_fac$n_sp==5),"model"],rep("5",sum(table_fac$n_sp==5)),rep("Int",sum(table_fac$n_sp==5))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==10),"success_fac"],table_fac[which(table_fac$n_sp==10),"model"],rep("10",sum(table_fac$n_sp==10)),rep("Int",sum(table_fac$n_sp==10))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==20),"success_fac"],table_fac[which(table_fac$n_sp==20),"model"],rep("20",sum(table_fac$n_sp==20)),rep("Int",sum(table_fac$n_sp==20))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$sparsity=="dense"),"success_fac"],table_fac[which(table_fac$sparsity=="dense"),"model"],rep("dense",sum(table_fac$sparsity=="dense")),rep("Int",sum(table_fac$sparsity=="dense"))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$sparsity=="sparse"),"success_fac"],table_fac[which(table_fac$sparsity=="sparse"),"model"],rep("sparse",sum(table_fac$sparsity=="sparse")),rep("Int",sum(table_fac$sparsity=="sparse"))))
tf<-rbind(tf,cbind(table_fac$success_env,table_fac$model,rep("All_env",nrow(table_fac)),rep("Env",nrow(table_fac))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==5),"success_env"],table_fac[which(table_fac$n_sp==5),"model"],rep("5_env",sum(table_fac$n_sp==5)),rep("Env",sum(table_fac$n_sp==5))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==10),"success_env"],table_fac[which(table_fac$n_sp==10),"model"],rep("10_env",sum(table_fac$n_sp==10)),rep("Env",sum(table_fac$n_sp==10))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==20),"success_env"],table_fac[which(table_fac$n_sp==20),"model"],rep("20_env",sum(table_fac$n_sp==20)),rep("Env",sum(table_fac$n_sp==20))))

tf<-data.frame("success"=as.numeric(tf[,1]),"model"=tf[,2],"fac"=tf[,3],"int"=rep("Facilitation",nrow(tf)),"col"=tf[,4])

table<-rbind(tf,tc)
table_nodr<- table[-which(table$model=="DR-GJAM"),]
p<-ggplot(data=table)+geom_boxplot(aes(y=as.numeric(success),x=as.factor(fac),fill=as.factor(col)))+
  scale_x_discrete(name="Parameters", breaks=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"),
                   labels=c("All","5","10","20","dense","sparse","All","5","10","20"),limits=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"))+
  scale_y_continuous(name="% success")+
  scale_fill_discrete(name = "Success in retrieving", labels = c("Sensibility (non int.)","Sensitivity (int.)"))+theme_bw()+ theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position="top",plot.title = element_text(hjust = 0.5))+
  facet_grid( int~model, scales="free")+ggtitle("Pairs indentification by correlation") 
p


#pdf("Correlation_suc_nodr.pdf")

p_ndr<-ggplot(data=table_nodr)+geom_boxplot(aes(y=as.numeric(success),x=as.factor(fac),fill=as.factor(col)))+
  scale_x_discrete(name="Parameters", breaks=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"),
                   labels=c("All","5","10","20","dense","sparse","All","5","10","20"),limits=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"))+
  scale_y_continuous(name="% success")+
  scale_fill_discrete(name = "Success in retrieving", labels = c("Sensibility (non int.)","Sensitivity (int.)"))+theme_bw()+ theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position="top",plot.title = element_text(hjust = 0.5))+
  facet_grid( int~model, scales="free")+ggtitle("Pairs indentification by correlation") 
p_ndr

#dev.off()

```






## Partial correlation




```{r inter_partial correlations, echo=FALSE, warning=FALSE}


all_part<-list("j_metric_e5"=j_metric_e5_p, "j_metric_e10"=j_metric_e10_p,"j_metric_e20"=j_metric_e20_p,
          "j_metric_facDense5"=j_metric_facDense5_p,"j_metric_facDense10"=j_metric_facDense10_p,"j_metric_facDense20"=j_metric_facDense20,
  "j_metric_facSparse5"=j_metric_facSparse5_p,"j_metric_facSparse10"=j_metric_facSparse10_p,"j_metric_facSparse20"=j_metric_facSparse20_p,
    "j_metric_compDense5"=j_metric_compDense5_p,"j_metric_compDense10"=j_metric_compDense10_p,"j_metric_compDense20"=j_metric_compDense20_p,
  "j_metric_compSparse5"=j_metric_compSparse5_p, "j_metric_compSparse10"=j_metric_compSparse10_p, "j_metric_compSparse20"=j_metric_compSparse20_p,"j_metric_faccompSparseSp5"=j_metric_FacCompSparse5_p, "j_metric_faccompSparseSp10"=j_metric_FacCompSparse10_p,
        "j_metric_faccompSparseSp20"=j_metric_FacCompSparse20_p,
          "j_metric_faccompDenseSp5"=j_metric_FacCompDense5_p,
         "j_metric_faccompDenseSp10"=j_metric_FacCompDense10_p,
        "j_metric_faccompDenseSp20"=j_metric_FacCompDense20_p,
          "g_metric_e5"=g_metric_e5_p,"g_dr_metric_e5"=g_dr_metric_e5_p,"h_metric_e5"=h_metric_e5_p,
          "g_metric_e10"=g_metric_e10_p,"g_dr_metric_e10"=g_dr_metric_e10_p,"h_metric_e10"=h_metric_e10_p,
          "g_metric_e20"=g_metric_e20_p,"g_dr_metric_e20"=g_dr_metric_e20_p,"h_metric_e20"=h_metric_e20_p,
          "h_metric_facDense5"=h_metric_facDense5_p,"g_metric_facDense5"=g_metric_facDense5_p,"g_dr_facDense5"=g_dr_metric_facDense5_p,
          "h_metric_facDense10"=h_metric_facDense10_p,"g_metric_facDense10"=g_metric_facDense10_p,"g_dr_metric_facDense10"=g_dr_metric_facDense10_p,
          "h_metric_facDense20"=h_metric_facDense20_p,"g_metric_facDense20"=g_metric_facDense20_p,"g_dr_metric_facDense20"=g_dr_metric_facDense20_p,
          "h_metric_facSparse5"=h_metric_facSparse5_p,"g_metric_facSparse5"=g_metric_facSparse5_p,"g_dr_metric_facSparse5"=g_dr_metric_facSparse5_p,
          "h_metric_facSparse10"=h_metric_facSparse10_p,"g_metric_facSparse10"=g_metric_facSparse10_p,"g_dr_metric_facSparse10"=g_dr_metric_facSparse10_p,
          "h_metric_facSparse20"=h_metric_facSparse20_p,"g_metric_facSparse20"=g_metric_facSparse20_p,"g_dr_metric_facSparse20"=g_dr_metric_facSparse20_p,
          "h_metric_compDense5"=h_metric_compDense5_p,"g_metric_compDense5"=g_metric_compDense5_p,"g_dr_metric_compDense5"=g_dr_metric_compDense5_p,
          "h_metric_compDense10"=h_metric_compDense10_p,"g_metric_compDense10"=g_metric_compDense10_p,"g_dr_metric_compDense10"=g_dr_metric_compDense10_p,
          "h_metric_compDense20"=h_metric_compDense20_p,"g_metric_compDense20"=g_metric_compDense20_p,"g_dr_metric_compDense20"=g_dr_metric_compDense20_p,
          "h_metric_compSparse5"=h_metric_compSparse5_p,"g_metric_compSparse5"=g_metric_compSparse5_p,"g_dr_metric_compSparse5"=g_dr_metric_compSparse5_p,
          "h_metric_compSparse10"=h_metric_compSparse10_p,"g_metric_compSparse10"=g_metric_compSparse10_p,"g_dr_metric_compSparse10"=g_dr_metric_compSparse10_p,
          "h_metric_compSparse20"=h_metric_compSparse20_p,"g_metric_compSparse20"=g_metric_compSparse20_p,"g_dr_metric_compSparse20"=g_dr_metric_compSparse20_p,
          "g_metric_faccompSparseSp5"= g_metric_FacCompSparse5_p,"h_metric_faccompSparseSp5"=h_metric_FacCompSparse5_p, "g_dr_metric_FacCompSparse5"=g_dr_metric_FacCompSparse5_p,
          "g_metric_faccompSparseSp10"= g_metric_FacCompSparse10_p,"h_metric_faccompSparseSp10"=h_metric_FacCompSparse10_p,"g_dr_metric_FacCompSparse10"=g_dr_metric_FacCompSparse10_p,
          "g_metric_faccompSparseSp20"= g_metric_FacCompSparse20_p,"h_metric_faccompSparseSp20"=h_metric_FacCompSparse20_p,"g_dr_metric_FacCompSparse20"=g_dr_metric_FacCompSparse20_p,
          "g_metric_faccompDenseSp5"= g_metric_FacCompDense5_p,"h_metric_faccompDenseSp5"=h_metric_FacCompDense5_p, "g_dr_metric_FacCompDense5"=g_dr_metric_FacCompDense5_p,
          "g_metric_faccompDenseSp10"= g_metric_FacCompDense10_p,"h_metric_faccompDenseSp10"=h_metric_FacCompDense10_p,"g_dr_metric_FacCompDense10"=g_dr_metric_FacCompDense10_p,
          "g_metric_faccompDenseSp20"= g_metric_FacCompDense20_p,"h_metric_faccompDenseSp20"=h_metric_FacCompDense20_p,"g_dr_metric_FacCompDense20"=g_dr_metric_FacCompDense20_p
        )
 


          
table<-as.data.frame(matrix(NA,nrow=63, ncol=8,dimnames=list(NULL,c("success_env","success_comp","success_fac","n_sp","Facilitation","Competition","sparsity","model"))))         

                                                
for(i in 1:length(names(all_part))){
  if(!is.null(all_part[[i]]$success_env)) table[i,"success_env"]<-all_part[[i]]$success_env
  if(!is.null(all_part[[i]]$success_comp)) table[i,"success_comp"]<-all_part[[i]]$success_comp
  if(!is.null(all_part[[i]]$success_fac)) table[i,"success_fac"]<-all_part[[i]]$success_fac
  
  if(length(grep("5",names(all_part)[i]))>0) table[i,"n_sp"]<-5
  if(length(grep("10",names(all_part)[i]))>0) table[i,"n_sp"]<-10
  if(length(grep("20",names(all_part)[i]))>0) table[i,"n_sp"]<-20
  
  if(length(grep("fac",names(all_part)[i]))>0){ table[i,"Facilitation"]<-"facilitation"}#else{table[i,"facilition"]<-NULL}
  if(length(grep("comp",names(all_part)[i]))>0){ table[i,"Competition"]<-"competition"}#else{table[i,"competition"]<-NULL}
  #if(!(length(grep("comp",names(all_part)[i]))>0) | length(grep("fac",names(all_part)[i]))>0) {table[i,"Comp_fac"]<-"comp_fac"}else{table[i,"Comp_fac"]<-NULL}
  
  if(length(grep("Dense",names(all_part)[i]))>0){ table[i,"sparsity"]<-"dense"}else{table[i,"sparsity"]<-"sparse"}
  
  if(length(grep("j_",names(all_part)[i]))>0) table[i,"model"]<-"CM"
  if(length(grep("g_m",names(all_part)[i]))>0) table[i,"model"]<-"GJAM"
   if(length(grep("g_dr",names(all_part)[i]))>0) table[i,"model"]<-"DR-GJAM"
  if(length(grep("h_",names(all_part)[i]))>0) table[i,"model"]<-"HMSC"
  
}

table_comp<-table[which(!is.na(table$success_comp)),]
table_fac<-table[which(!is.na(table$success_fac)),]

tc<-cbind(table_comp$success_comp,table_comp$model,rep("All",nrow(table_comp)),rep("Int",nrow(table_comp)))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==5),"success_comp"],table_comp[which(table_comp$n_sp==5),"model"],rep("5",sum(table_comp$n_sp==5)),rep("Int",sum(table_comp$n_sp==5))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==10),"success_comp"],table_comp[which(table_comp$n_sp==10),"model"],rep("10",sum(table_comp$n_sp==10)),rep("Int",sum(table_comp$n_sp==10))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==20),"success_comp"],table_comp[which(table_comp$n_sp==20),"model"],rep("20",sum(table_comp$n_sp==20)),rep("Int",sum(table_comp$n_sp==20))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$sparsity=="dense"),"success_comp"],table_comp[which(table_comp$sparsity=="dense"),"model"],rep("dense",sum(table_comp$sparsity=="dense")),rep("Int",sum(table_comp$sparsity=="dense"))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$sparsity=="sparse"),"success_comp"],table_comp[which(table_comp$sparsity=="sparse"),"model"],rep("sparse",sum(table_comp$sparsity=="sparse")),rep("Int",sum(table_comp$sparsity=="sparse"))))
tc<-rbind(tc,cbind(table_comp$success_env,table_comp$model,rep("All_env",nrow(table_comp)),rep("Env",nrow(table_comp))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==5),"success_env"],table_comp[which(table_comp$n_sp==5),"model"],rep("5_env",sum(table_comp$n_sp==5)),rep("Env",sum(table_comp$n_sp==5))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==10),"success_env"],table_comp[which(table_comp$n_sp==10),"model"],rep("10_env",sum(table_comp$n_sp==10)),rep("Env",sum(table_comp$n_sp==10))))
tc<-rbind(tc,cbind(table_comp[which(table_comp$n_sp==20),"success_env"],table_comp[which(table_comp$n_sp==20),"model"],rep("20_env",sum(table_comp$n_sp==20)),rep("Env",sum(table_comp$n_sp==20))))

tc<-data.frame("success"=as.numeric(tc[,1]),"model"=tc[,2],"fac"=tc[,3],"int"=rep("Competition",nrow(tc)),"col"=tc[,4])



tf<-cbind(table_fac$success_fac,table_fac$model,rep("All",nrow(table_fac)),rep("Int",nrow(table_fac)))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==5),"success_fac"],table_fac[which(table_fac$n_sp==5),"model"],rep("5",sum(table_fac$n_sp==5)),rep("Int",sum(table_fac$n_sp==5))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==10),"success_fac"],table_fac[which(table_fac$n_sp==10),"model"],rep("10",sum(table_fac$n_sp==10)),rep("Int",sum(table_fac$n_sp==10))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==20),"success_fac"],table_fac[which(table_fac$n_sp==20),"model"],rep("20",sum(table_fac$n_sp==20)),rep("Int",sum(table_fac$n_sp==20))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$sparsity=="dense"),"success_fac"],table_fac[which(table_fac$sparsity=="dense"),"model"],rep("dense",sum(table_fac$sparsity=="dense")),rep("Int",sum(table_fac$sparsity=="dense"))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$sparsity=="sparse"),"success_fac"],table_fac[which(table_fac$sparsity=="sparse"),"model"],rep("sparse",sum(table_fac$sparsity=="sparse")),rep("Int",sum(table_fac$sparsity=="sparse"))))
tf<-rbind(tf,cbind(table_fac$success_env,table_fac$model,rep("All_env",nrow(table_fac)),rep("Env",nrow(table_fac))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==5),"success_env"],table_fac[which(table_fac$n_sp==5),"model"],rep("5_env",sum(table_fac$n_sp==5)),rep("Env",sum(table_fac$n_sp==5))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==10),"success_env"],table_fac[which(table_fac$n_sp==10),"model"],rep("10_env",sum(table_fac$n_sp==10)),rep("Env",sum(table_fac$n_sp==10))))
tf<-rbind(tf,cbind(table_fac[which(table_fac$n_sp==20),"success_env"],table_fac[which(table_fac$n_sp==20),"model"],rep("20_env",sum(table_fac$n_sp==20)),rep("Env",sum(table_fac$n_sp==20))))

tf<-data.frame("success"=as.numeric(tf[,1]),"model"=tf[,2],"fac"=tf[,3],"int"=rep("Facilitation",nrow(tf)),"col"=tf[,4])

table<-rbind(tf,tc)
table_p_nodr<- table[-which(table$model=="DR-GJAM"),]

#pdf("plot_partial_inter.pdf")

p<-ggplot(data=table)+geom_boxplot(aes(y=as.numeric(success),x=as.factor(fac),fill=as.factor(col)))+
  scale_x_discrete(name="Parameters", breaks=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"),
                   labels=c("All","5","10","20","dense","sparse","All","5","10","20"),limits=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"))+
  scale_y_continuous(name="% success")+
  scale_fill_discrete(name = "Success in retrieving", labels = c("Sensibility (non int.)","Sensitivity (int.)"))+theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 0.5),legend.position="top",plot.title = element_text(hjust = 0.5))+
  facet_grid( int~model , scales="free") +ggtitle("Pairs indentification by partial correlation") 
p
#dev.off()



#pdf("plot_partial_inter_nodr.pdf")

p_ndr<-ggplot(data=table_p_nodr)+geom_boxplot(aes(y=as.numeric(success),x=as.factor(fac),fill=as.factor(col)))+
  scale_x_discrete(name="Parameters", breaks=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"),
                   labels=c("All","5","10","20","dense","sparse","All","5","10","20"),limits=c("All","5","10","20","dense","sparse","All_env","5_env","10_env","20_env"))+
  scale_y_continuous(name="% success")+
  scale_fill_discrete(name = "Success in retrieving", labels = c("Sensibility (non int.)","Sensitivity (int.)"))+theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 0.5),legend.position="top",plot.title = element_text(hjust = 0.5))+
  facet_grid( int~model , scales="free") +ggtitle("Pairs indentification by partial correlation") 
p_ndr

#dev.off()


```





## Prediction abilities





```{r prediction abilities, echo=FALSE}

AUCs<-list(AUC_j_env=AUC_j_env,AUC_g_env=AUC_g_env,AUC_gdr_env=AUC_gdr_env,AUC_h_env=AUC_h_env,
           AUC_j_fac_dense=AUC_j_fac_dense,AUC_g_fac_dense=AUC_g_fac_dense,AUC_gdr_fac_dense=AUC_gdr_fac_dense,AUC_h_fac_dense=AUC_h_fac_dense,
           AUC_j_fac_sparse=AUC_j_fac_sparse,AUC_g_fac_sparse=AUC_g_fac_sparse,AUC_gdr_fac_sparse=AUC_gdr_fac_sparse,AUC_h_fac_sparse=AUC_h_fac_sparse,
           AUC_j_comp_dense=AUC_j_comp_dense,AUC_g_comp_dense=AUC_g_comp_dense,AUC_gdr_comp_dense=AUC_gdr_comp_dense,AUC_h_comp_dense=AUC_h_comp_dense,
           AUC_j_comp_sparse=AUC_j_comp_sparse,AUC_g_comp_sparse=AUC_g_comp_sparse,AUC_gdr_comp_sparse=AUC_gdr_comp_sparse,AUC_h_comp_sparse=AUC_h_comp_sparse,
           AUC_j_comp_fac_dense=AUC_j_comp_fac_dense,AUC_g_comp_fac_dense=AUC_g_comp_fac_dense,AUC_gdr_comp_fac_dense=AUC_gdr_comp_fac_dense,AUC_h_comp_fac_dense=AUC_h_comp_fac_dense,
           AUC_j_comp_fac_sparse=AUC_j_comp_fac_sparse,AUC_g_comp_fac_sparse=AUC_g_comp_fac_sparse,AUC_gdr_comp_fac_sparse=AUC_gdr_comp_fac_sparse,AUC_h_comp_fac_sparse=AUC_h_comp_fac_sparse)

table<-as.data.frame(matrix(ncol=4,dimnames = list(NULL,c("AUC","Model","Filtering","Density"))))
for(i in 1:length(AUCs)){
  k<-ifelse(nrow(table)==1,0,nrow(table))
  table[(k+1):(k+length(AUCs[[i]])),"AUC"]<-AUCs[[i]]
  if(length(grep("_j_",names(AUCs)[[i]]))>0)  table[(k+1):(k+length(AUCs[[i]])),"Model"]<-rep("CM",length(AUCs[[i]]))
  
  if(length(grep("_g_",names(AUCs)[[i]]))>0)  table[(k+1):(k+length(AUCs[[i]])),"Model"]<-rep("GJAM",length(AUCs[[i]]))
  if(length(grep("_gdr_",names(AUCs)[[i]]))>0)  table[(k+1):(k+length(AUCs[[i]])),"Model"]<-rep("DR-GJAM",length(AUCs[[i]]))
  
  if(length(grep("_h_",names(AUCs)[[i]]))>0)  table[(k+1):(k+length(AUCs[[i]])),"Model"]<-rep("HMSC",length(AUCs[[i]]))
  
  
  if(length(grep("_comp_fac_",names(AUCs)[[i]]))>0){
    table[(k+1):(k+length(AUCs[[i]])),"Filtering"]<-rep("C+F",length(AUCs[[i]]))
  }else{if(length(grep("_fac_",names(AUCs)[[i]]))>0) { table[(k+1):(k+length(AUCs[[i]])),"Filtering"]<-rep("Fac",length(AUCs[[i]]))
  }else{if(length(grep("_comp_",names(AUCs)[[i]]))>0) { table[(k+1):(k+length(AUCs[[i]])),"Filtering"]<-rep("Comp",length(AUCs[[i]])) }
  }
  }
  if(length(grep("_env",names(AUCs)[[i]]))>0) table[(k+1):(k+length(AUCs[[i]])),"Filtering"]<-rep("Env",length(AUCs[[i]]))

  
 if(length(grep("_dense",names(AUCs)[[i]]))>0){
   table[(k+1):(k+length(AUCs[[i]])),"Density"]<-rep("Dense",length(AUCs[[i]]))
  }else{ table[(k+1):(k+length(AUCs[[i]])),"Density"]<-rep("Sparse",length(AUCs[[i]]))
  }
  
}
  
table[nrow(table)+1,]<-c(-1,"CM", "Env","Dense")
table[nrow(table)+1,]<-c(-1,"GJAM", "Env","Dense")
table[nrow(table)+1,]<-c(-1,"DR-GJAM", "Env","Dense")
table[nrow(table)+1,]<-c(-1,"HMSC", "Env","Dense")


table$Filtering<-factor(table$Filtering, levels=c("Env","Fac","Comp","C+F"))


#png("plot_AUC_in.png")
#pdf("plot_AUC_in_sample.pdf")
p<-ggplot(data=table)+geom_boxplot(aes(y=as.numeric(AUC),x=Filtering,fill=Model),position = position_dodge(1,preserve = "single"))+
  ylim(c(0,1)) +facet_grid(Density~.,scales = "free")+ theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 10),strip.text = element_text(size = 15),legend.position = "top",plot.title = element_text(hjust = 0.5))+ylab("AUC")+ scale_x_discrete(name="Filtering", breaks=c("Env","Fac","Comp","C+F"),
                   labels=c("Environmental","Facilitation","Competition","Comp.+Fac."))+
ggtitle("Accuracy of model in-sample predictions averaged across communities") +theme_bw()
p



table_auc_nodr<- table[-which(table$Model=="DR_GJAM"),]



#png("plot_AUC_in.png")
#pdf("plot_AUC_in_sample_nodr.pdf")
p<-ggplot(data=table_auc_nodr)+geom_boxplot(aes(y=as.numeric(AUC),x=Filtering,fill=Model),position = position_dodge(1,preserve = "single"))+
  ylim(c(0,1)) +facet_grid(Density~.,scales = "free")+ theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 10),strip.text = element_text(size = 15),legend.position = "top",plot.title = element_text(hjust = 0.5))+ylab("AUC")+ scale_x_discrete(name="Filtering", breaks=c("Env","Fac","Comp","C+F"),
                   labels=c("Environmental","Facilitation","Competition","Comp.+Fac."))+
ggtitle("Accuracy of model in-sample predictions averaged across communities") +theme_bw()
p

#dev.off()

```





